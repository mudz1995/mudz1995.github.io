<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø­ÙŠØ§ØªÙŠ | v10.1 (Ø¥ØµÙ„Ø§Ø­)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2979ff;
            --primary-light: #e3f2fd;
            --secondary-color: #00e676;
            --background-color: #f4f7fa;
            --card-bg: #ffffff;
            --text-color: #333;
            --text-light: #757575;
            --radius: 16px;
            --danger-color: #ff3d00;
            --warning-color: #ffab00;
            --priority-high: #ff3d00;
            --priority-medium: #ffab00;
            --priority-low: #2979ff;
        }
        * { box-sizing: border-box; }
        body {
            font-family: 'Tajawal', 'Arial', sans-serif;
            background-color: var(--background-color);
            margin: 0;
            padding: 15px;
            color: var(--text-color);
            direction: rtl;
            text-align: right;
        }
        .dashboard-container { max-width: 1000px; margin: 0 auto; }
        .header {
            background: linear-gradient(135deg, var(--primary-color), #5393ff);
            color: white; padding: 25px; border-radius: var(--radius);
            margin-bottom: 20px; text-align: center;
            box-shadow: 0 6px 20px rgba(41, 121, 255, 0.3);
        }
        .header h1 { margin: 0; font-size: 1.8em; }
        
        .tabs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin-bottom: 25px;
        }
        .tab-link {
            padding: 12px 10px;
            border-radius: var(--radius);
            text-decoration: none;
            color: var(--text-color);
            background-color: var(--card-bg);
            transition: all 0.3s;
            font-weight: 700;
            font-size: 0.9em;
            cursor: pointer; border: none;
            font-family: 'Tajawal', 'Arial', sans-serif;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        .tab-link:hover, .tab-link[aria-selected="true"] {
            background-color: var(--primary-color);
            color: white;
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(41, 121, 255, 0.4);
        }
        .tab-link .icon { font-size: 1.5em; }
        
        .card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: var(--radius);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.06);
            margin-bottom: 20px;
            transition: all 0.3s;
        }
        .grid-2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
        .grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; text-align: center; }
        
        h2 {
            font-size: 1.6em;
            color: var(--text-color);
            margin-bottom: 20px;
            border-bottom: 3px solid var(--primary-color);
            padding-bottom: 10px;
        }
        h3 { color: var(--text-color); margin-top: 0; font-size: 1.3em; }
        h4.task-name { font-size: 1.1em; }
        
        input[type="text"], input[type="number"], input[type="date"], select {
            width: 100%; padding: 16px; margin-bottom: 12px;
            border: 2px solid #e0e0e0; border-radius: 12px;
            font-size: 1em; direction: rtl;
            background-color: #f9f9f9;
            font-family: 'Tajawal', 'Arial', sans-serif;
            transition: all 0.3s;
        }
        input:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
            background-color: white;
            box-shadow: 0 0 10px rgba(41, 121, 255, 0.2);
        }
        input[type="checkbox"] {
            width: 20px; height: 20px;
            accent-color: var(--primary-color);
        }
        
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #555; }
        
        .progress-bar { height: 12px; background-color: #e9ecef; border-radius: 6px; margin-top: 10px; overflow: hidden; }
        .progress-bar div { height: 100%; background: linear-gradient(90deg, var(--secondary-color), var(--primary-color)); transition: width 0.5s ease; }
        
        .habit-card { padding: 20px; min-height: 160px; text-align: center; }
        .days-tracker { display: flex; justify-content: space-between; margin-top: 15px; gap: 5px; }
        .day-box {
            width: 35px; height: 35px; border-radius: 50%;
            background-color: #e9ecef; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.9em; font-weight: bold; transition: all 0.3s;
            border: 2px solid transparent;
        }
        .day-box:hover { border-color: var(--primary-color); transform: scale(1.1); }
        .day-box.completed {
            background-color: var(--secondary-color); color: white;
            box-shadow: 0 2px 8px rgba(0, 230, 118, 0.5);
        }
        .day-box.failed {
            background-color: var(--danger-color);
            color: white;
            box-shadow: 0 2px 8px rgba(255, 61, 0, 0.4);
            font-size: 1.4em;
            line-height: 1;
        }
        
        .btn {
            color: white; border: none; padding: 16px 22px;
            border-radius: 12px; cursor: pointer; margin-top: 10px;
            transition: all 0.3s; font-weight: 700;
            font-family: 'Tajawal', 'Arial', sans-serif;
            font-size: 1em; width: 100%;
        }
        .btn:disabled { background: #aaa; cursor: not-allowed; opacity: 0.7; }
        .btn-primary { background: var(--primary-color); box-shadow: 0 4px 12px rgba(41, 121, 255, 0.3); }
        .btn-primary:hover:not(:disabled) { background: #1967d2; transform: translateY(-2px); }
        .btn-danger { background-color: var(--danger-color); box-shadow: 0 4px 12px rgba(255, 61, 0, 0.3); }
        .btn-danger:hover:not(:disabled) { background-color: #c82333; transform: translateY(-2px); }
        .btn-secondary { background-color: #6c757d; }
        .btn-secondary:hover:not(:disabled) { background-color: #5a6268; transform: translateY(-2px); }
        
        .btn-icon {
            background: none; border: none; color: var(--danger-color);
            cursor: pointer; margin: 0; padding: 5px;
            font-size: 1.4em; width: auto;
        }
        .btn-icon:hover { color: #c82333; }
        .btn-icon.btn-edit {
            color: var(--primary-color);
            font-size: 1.2em;
        }
        .btn-icon.btn-edit:hover { color: #1967d2; }

        .btn-group { display: flex; gap: 10px; }
        .btn-group .btn { width: 50%; }
        
        .content-section { display: none; }
        .content-section.active, .content-section[aria-hidden="false"] { display: block; }
        
        #notification {
            position: fixed; bottom: 20px; right: 20px;
            padding: 15px 25px; border-radius: 10px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
            z-index: 1000; display: none; font-weight: 600;
        }
        #notification.success { background-color: var(--secondary-color); color: white; }
        #notification.error { background-color: var(--danger-color); color: white; }
        
        .task-card { margin-bottom: 10px; padding: 15px; }
        .task-card-header {
            display: flex; justify-content: space-between; align-items: center;
        }
        .task-card-header .task-name { flex: 1; margin: 0 10px; font-size: 1.1em; }
        .task-card.completed { opacity: 0.7; background-color: #f8f9fa; }
        .task-card .task-name.completed { text-decoration: line-through; }
        .task-card.overdue { border-right: 5px solid var(--danger-color); }
        .task-card.priority-high { border-right: 5px solid var(--priority-high); }
        .task-card.priority-medium { border-right: 5px solid var(--priority-medium); }
        .task-card.priority-low { border-right: 5px solid var(--priority-low); }
        .task-card-footer {
            display: flex; justify-content: space-between; align-items: center;
            margin-top: 10px; padding-top: 10px; border-top: 1px solid #f0f0f0;
            font-size: 0.9em; color: var(--text-light);
        }
        .due-date-tag {
            background-color: var(--warning-color); color: #333;
            padding: 5px 12px; border-radius: 20px;
            font-size: 0.85em; font-weight: 600;
        }
        .due-date-tag.overdue { background-color: var(--danger-color); color: white; }
        .due-date-tag.completed { background-color: var(--secondary-color); color: white; }
        .priority-badge {
            padding: 5px 12px; border-radius: 20px;
            font-size: 0.85em; font-weight: 600;
        }
        .priority-high { background-color: var(--priority-high); color: white; }
        .priority-medium { background-color: var(--priority-medium); color: white; }
        .priority-low { background-color: var(--priority-low); color: white; }
        
        .list-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px; border-bottom: 1px solid #eee;
        }
        .list-item span { display: flex; flex-direction: column; }
        .list-item .list-item-name { font-weight: 600; }
        .list-item .list-item-amount { font-size: 0.9em; color: var(--text-light); }
        .list-item:last-child { border-bottom: none; }
        
        .income-list-item {
            display: flex; align-items: center;
            padding: 10px; border-bottom: 1px solid #eee;
        }
        .income-list-item input[type="checkbox"] { margin: 0 0 0 15px; }
        .income-list-item .details { flex: 1; }
        .income-list-item .details .name { font-weight: 600; }
        .income-list-item .details .amount { font-size: 0.9em; color: var(--text-light); }
        .income-list-item .amount-display { font-weight: 700; color: var(--secondary-color); }
        .income-list-item.not-expected .name { text-decoration: line-through; opacity: 0.7; }
        .income-list-item.not-expected .amount-display { opacity: 0.7; }

        .empty-state {
            text-align: center; color: #777; padding: 40px 20px;
            background: #fdfdfd; border: 2px dashed #e0e0e0;
            border-radius: var(--radius);
        }

        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        .stat-card {
            padding: 20px;
            text-align: center;
        }
        .chart-container {
            position: relative;
            width: 150px;
            height: 150px;
            margin: 15px auto;
        }
        .chart-container canvas {
            position: absolute;
            top: 0;
            left: 0;
        }
        .chart-percent {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2em;
            font-weight: 700;
            color: var(--primary-color);
        }
        
        .salary-summary-card { padding: 20px; text-align: center; }
        .salary-summary-card h3 { font-size: 1.1em; color: var(--text-light); margin-bottom: 5px; }
        .salary-summary-card .value {
            font-size: 1.8em;
            font-weight: 700;
        }
        .salary-summary-card .value.positive { color: var(--secondary-color); }
        .salary-summary-card .value.negative { color: var(--danger-color); }
        .salary-summary-card .value.neutral { color: var(--primary-color); }

        .salary-tracker-card {
            border-right: 5px solid var(--primary-color);
        }
        .salary-stat {
            display: flex; justify-content: space-between;
            font-size: 1.1em; margin-bottom: 10px;
        }
        .salary-stat .label { font-weight: 600; }
        .salary-stat .value.spent {
            color: var(--danger-color);
            font-weight: 700;
        }
        .salary-stat .value.remaining {
            color: var(--secondary-color);
            font-weight: 700;
        }
        .salary-stat .value.remaining.over {
            color: var(--danger-color);
            font-weight: 700;
        }

        .sinking-fund-card {
            border-right: 5px solid var(--secondary-color);
        }

        .modal { display: none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
        .modal-content { background-color: #fff; margin: auto; padding: 25px; border-radius: var(--radius); max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px; }
        .modal-header h3 { margin: 0; color: var(--primary-color); }
        .modal-close { font-size: 2em; font-weight: bold; cursor: pointer; }

        @media (max-width: 768px) {
            .grid-2, .grid-3 { grid-template-columns: 1fr; }
            .day-box { width: 28px; height: 28px; }
            .tabs { grid-template-columns: 1fr 1fr 1fr; }
        }
    </style>
</head>
<body>
    <div id="notification" role="alert" aria-live="polite"></div>

    <div id="archiveModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙŠÙˆÙ…</h3>
                <span id="modalCloseBtn" class="modal-close" aria-label="Ø¥ØºÙ„Ø§Ù‚">&times;</span>
            </div>
            <div id="modalBody"></div>
        </div>
    </div>
    
    <div class="dashboard-container">
        <header class="header">
            <h1>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø­ÙŠØ§ØªÙŠ ğŸš€</h1>
            <p style="margin: 10px 0 0 0;">Ù†Ø¸Ù‘Ù… Ø­ÙŠØ§ØªÙƒ Ø§Ù„Ù…Ø§Ù„ÙŠØ© ÙˆØ§Ù„Ø´Ø®ØµÙŠØ© ÙÙŠ Ù…ÙƒØ§Ù† ÙˆØ§Ø­Ø¯</p>
        </header>

        <nav class="tabs" role="tablist">
            <button id="tab-financial" data-target="#financial" class="tab-link active" role="tab" aria-selected="true" aria-controls="financial"><span class="icon">ğŸ’°</span>Ø§Ù„Ù…Ø§Ù„ÙŠØ©</button>
            <button id="tab-salary" data-target="#salary-planner" class="tab-link" role="tab" aria-selected="false" aria-controls="salary-planner"><span class="icon">ğŸ’¸</span>Ø§Ù„Ø±Ø§ØªØ¨</button>
            <button id="tab-sinking" data-target="#sinking-funds" class="tab-link" role="tab" aria-selected="false" aria-controls="sinking-funds"><span class="icon">ğŸ›¡ï¸</span>Ø§Ù„ØµÙ†Ø§Ø¯ÙŠÙ‚</button>
            <button id="tab-tasks" data-target="#tasks" class="tab-link" role="tab" aria-selected="false" aria-controls="tasks"><span class="icon">âœ…</span>Ø§Ù„Ù…Ù‡Ø§Ù…</button>
            <button id="tab-habits" data-target="#habits" class="tab-link" role="tab" aria-selected="false" aria-controls="habits"><span class="icon">ğŸ§˜</span>Ø§Ù„Ø¹Ø§Ø¯Ø§Øª</button>
            <button id="tab-uber" data-target="#uber-tracker" class="tab-link" role="tab" aria-selected="false" aria-controls="uber-tracker"><span class="icon">ğŸš•</span>Ø£ÙˆØ¨Ø±</button>
            <button id="tab-stats" data-target="#stats" class="tab-link" role="tab" aria-selected="false" aria-controls="stats"><span class="icon">ğŸ“Š</span>Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</button>
            <button id="tab-backup" data-target="#backup" class="tab-link" role="tab" aria-selected="false" aria-controls="backup"><span class="icon">âš™ï¸</span>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
        </nav>

        <section id="financial" class="content-section active" role="tabpanel" aria-labelledby="tab-financial">
            <h2>Ø§Ù„Ø£Ù‡Ø¯Ø§Ù Ø§Ù„Ù…Ø§Ù„ÙŠØ©</h2>
            <div class="card">
                <h3>Ø¥Ø¶Ø§ÙØ© Ù‡Ø¯Ù Ù…Ø§Ù„ÙŠ Ø¬Ø¯ÙŠØ¯</h3>
                <label for="goalName">Ø§Ø³Ù… Ø§Ù„Ù‡Ø¯Ù</label>
                <input type="text" id="goalName" placeholder="Ù…Ø«Ø§Ù„: Ø´Ø±Ø§Ø¡ Ø³ÙŠØ§Ø±Ø©">
                <label for="goalAmount">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù</label>
                <input type="number" id="goalAmount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù" min="1">
                <label for="currentSavings">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø­Ø§Ù„ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                <input type="number" id="currentSavings" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø­Ø§Ù„ÙŠ" min="0">
                <label for="goalDueDate">ØªØ§Ø±ÙŠØ® Ù…Ø³ØªÙ‡Ø¯Ù (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                <input type="date" id="goalDueDate">
                <button class="btn btn-primary" id="addGoalBtn">Ø¥Ø¶Ø§ÙØ©</button>
            </div>
            <div class="grid-2" id="financialGoalsContainer"></div>
        </section>

        <section id="salary-planner" class="content-section" role="tabpanel" aria-labelledby="tab-salary" aria-hidden="true">
            <h2>Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„ØµÙØ±ÙŠØ©</h2>
            
            <div class="card" style="text-align: center;">
                <h3 style="font-size: 1.1em; color: var(--text-light); margin-bottom: 5px;">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ù‚Ø§Ø¯Ù… (ÙŠÙˆÙ… <span id="salaryDayLabel">27</span>)</h3>
                <div class="value neutral" id="daysUntilSalaryDisplay" style="font-size: 2.2em; color: var(--secondary-color);">- Ø£ÙŠØ§Ù…</div>
            </div>

            <div class="card">
                <h3>Ù…Ù„Ø®Øµ Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©</h3>
                <div class="grid-3" style="gap: 10px;">
                    <div class="salary-summary-card">
                        <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯Ø®Ù„ (Ø§Ù„Ù…ØªÙˆÙ‚Ø¹)</h3>
                        <div class="value positive" id="totalExpectedIncomeDisplay">0 Ø±ÙŠØ§Ù„</div>
                    </div>
                    <div class="salary-summary-card">
                        <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø®ØµØµ</h3>
                        <div class="value neutral" id="totalAllocatedDisplay">0 Ø±ÙŠØ§Ù„</div>
                    </div>
                    <div class="salary-summary-card">
                        <h3>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù„Ù„ØªÙˆØ²ÙŠØ¹</h3>
                        <div class="value" id="unallocatedAmountDisplay">0 Ø±ÙŠØ§Ù„</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>Ø§Ù„Ø¯Ø®Ù„ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ (Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±)</h3>
                <p style="color: var(--text-light); line-height: 1.6; margin-top: -15px;">
                    Ø­Ø¯Ø¯ Ø§Ù„Ø¯Ø®Ù„ Ø§Ù„Ø°ÙŠ ØªØªÙˆÙ‚Ø¹ Ø§Ø³ØªÙ„Ø§Ù…Ù‡ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±.
                </p>
                <div id="incomeReceivedContainer"></div>
            </div>
            
            <div class="card">
                <h3>Ø¥Ø¶Ø§ÙØ© Ø¯Ø®Ù„ Ø¥Ø¶Ø§ÙÙŠ (Ù„Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±)</h3>
                 <div style="display:flex; gap:10px; margin-bottom: 15px;">
                    <input type="text" id="oneTimeIncomeName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ØµØ¯Ø± (Ø¹ÙŠØ¯ÙŠØ©ØŒ Ù‡Ø¯ÙŠØ©...)" style="margin-bottom:0;">
                    <input type="number" id="oneTimeIncomeAmount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" min="1" style="margin-bottom:0; flex-basis: 150px;">
                </div>
                <button class="btn btn-primary" id="addOneTimeIncomeBtn">Ø¥Ø¶Ø§ÙØ©</button>
            </div>

            <div class="card">
                <h3>Ø¥Ø¶Ø§ÙØ© ÙØ¦Ø© Ù…ÙŠØ²Ø§Ù†ÙŠØ©</h3>
                <input type="text" id="newCategoryName" placeholder="Ø§Ø³Ù… Ø§Ù„ÙØ¦Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (Ø¨Ù†Ø²ÙŠÙ†ØŒ Ø§Ø¯Ø®Ø§Ø±...)" style="margin-bottom:12px;">
                <button class="btn btn-primary" id="addCategoryBtn">Ø¥Ø¶Ø§ÙØ© ÙØ¦Ø©</button>
            </div>
            
            <div class="grid-2" id="budgetTrackerContainer"></div>
        </section>

        <section id="sinking-funds" class="content-section" role="tabpanel" aria-labelledby="tab-sinking" aria-hidden="true">
            <h2>ØµÙ†Ø§Ø¯ÙŠÙ‚ Ø§Ù„Ø§Ø¯Ø®Ø§Ø± ğŸ›¡ï¸</h2>
            <div class="card">
                <h3>Ø¥Ø¶Ø§ÙØ© ØµÙ†Ø¯ÙˆÙ‚ Ø§Ø¯Ø®Ø§Ø± Ø¬Ø¯ÙŠØ¯</h3>
                <p style="color: var(--text-light); line-height: 1.6; margin-top: -15px;">
                    Ø®Ø·Ø· Ù„Ù„Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„ÙƒØ¨ÙŠØ±Ø© (ØªØ£Ù…ÙŠÙ† Ø§Ù„Ø³ÙŠØ§Ø±Ø©ØŒ Ù‡Ø¯Ø§ÙŠØ§ Ø§Ù„Ø¹ÙŠØ¯...) Ø¨ØªÙˆÙÙŠØ± Ù…Ø¨Ø§Ù„Øº ØµØºÙŠØ±Ø© Ø´Ù‡Ø±ÙŠØ§Ù‹
                </p>
                <label for="fundName">Ø§Ø³Ù… Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚</label>
                <input type="text" id="fundName" placeholder="Ù…Ø«Ø§Ù„: ØªØ£Ù…ÙŠÙ† Ø§Ù„Ø³ÙŠØ§Ø±Ø©">
                <label for="fundTarget">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨</label>
                <input type="number" id="fundTarget" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ" min="1">
                <label for="fundDueDate">Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù</label>
                <input type="date" id="fundDueDate">
                <button class="btn btn-primary" id="addFundBtn">Ø¥Ø¶Ø§ÙØ© ØµÙ†Ø¯ÙˆÙ‚</button>
            </div>
            <div class="grid-2" id="sinkingFundsContainer"></div>
        </section>

        <section id="uber-tracker" class="content-section" role="tabpanel" aria-labelledby="tab-uber" aria-hidden="true">
            <h2 id="uberTitle">Ù‡Ø¯Ù Ø£ÙˆØ¨Ø± Ø§Ù„ÙŠÙˆÙ…ÙŠ (0 Ø±ÙŠØ§Ù„)</h2>
            <div class="card grid-2">
                <div><h3>ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­</h3><p class="uber-stat stat-net" id="uberNetProfit">0 Ø±ÙŠØ§Ù„</p></div>
                <div><h3>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</h3><p class="uber-stat stat-remaining" id="uberRemaining">0 Ø±ÙŠØ§Ù„</p></div>
            </div>
            <div class="card">
                <h3>Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø°ÙƒÙŠØ©</h3>
                <p>Ù„ØªØ­Ù‚ÙŠÙ‚ ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØŒ ØªØ­ØªØ§Ø¬ Ø¯Ø®Ù„ Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <span class="uber-stat stat-needed" id="uberGrossNeeded">0 Ø±ÙŠØ§Ù„</span></p>
            </div>
            <div class="card">
                <h3>ØªØ³Ø¬ÙŠÙ„ Ù…Ø´ÙˆØ§Ø±</h3>
                <input type="number" id="rideIncome" placeholder="Ø¯Ø®Ù„ Ø§Ù„Ù…Ø´ÙˆØ§Ø± Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ" min="1">
                <input type="number" id="rideExpense" placeholder="Ù…ØµØ±ÙˆÙ Ø¥Ø¶Ø§ÙÙŠ (Ø¨Ù†Ø²ÙŠÙ†...)" min="0">
                <button class="btn btn-primary" id="addRideBtn">Ø¥Ø¶Ø§ÙØ© Ù…Ø´ÙˆØ§Ø±</button>
            </div>
            <div class="card">
                <h3>Ù…ØµØ±ÙˆÙ Ø¹Ø§Ù… (Ø®Ø§Ø±Ø¬ Ø§Ù„Ù…Ø´Ø§ÙˆÙŠØ±)</h3>
                <input type="number" id="generalExpenseAmount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" min="1">
                <input type="text" id="generalExpenseName" placeholder="Ø§Ù„ÙˆØµÙ (ØºØ³ÙŠÙ„ Ø³ÙŠØ§Ø±Ø©...)">
                <button class="btn btn-primary" id="addGeneralExpenseBtn">ØªØ³Ø¬ÙŠÙ„ Ù…ØµØ±ÙˆÙ</button>
            </div>
            <div class="card">
                <h3>Ø³Ø¬Ù„ Ø§Ù„ÙŠÙˆÙ…</h3>
                <div id="ridesHistoryContainer"></div>
                <div id="generalExpensesHistoryContainer"></div>
                <button class="btn btn-danger" id="endUberDayBtn">Ø¥Ù†Ù‡Ø§Ø¡ ÙˆØ£Ø±Ø´ÙØ© Ø§Ù„ÙŠÙˆÙ…</button>
            </div>
        </section>

        <section id="tasks" class="content-section" role="tabpanel" aria-labelledby="tab-tasks" aria-hidden="true">
            <h2>Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ ÙˆØ§Ù„Ù…Ù‡Ø§Ù…</h2>
            <div class="card">
                <h3>Ø¥Ø¶Ø§ÙØ© Ù…Ø´Ø±ÙˆØ¹ Ø¬Ø¯ÙŠØ¯</h3>
                <input type="text" id="projectName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹">
                <button class="btn btn-primary" id="addProjectBtn">Ø¥Ø¶Ø§ÙØ© Ù…Ø´Ø±ÙˆØ¹</button>
            </div>
            <div class="card">
                <h3>Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3>
                <label for="taskProjectSelect">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</label>
                <select id="taskProjectSelect"></select>
                <label for="taskName">Ø§Ø³Ù… Ø§Ù„Ù…Ù‡Ù…Ø©</label>
                <input type="text" id="taskName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù‡Ù…Ø©">
                <label for="taskDueDate">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</label>
                <input type="date" id="taskDueDate">
                <label for="taskPriority">Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©</label>
                <select id="taskPriority">
                    <option value="low">Ù…Ù†Ø®ÙØ¶Ø© ğŸ”µ</option>
                    <option value="medium" selected>Ù…ØªÙˆØ³Ø·Ø© ğŸŸ </option>
                    <option value="high">Ø¹Ø§Ù„ÙŠØ© ğŸ”´</option>
                </select>
                <button class="btn btn-primary" id="addTaskBtn">Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø©</button>
            </div>
            <div id="projectsContainer"></div>
        </section>

        <section id="habits" class="content-section" role="tabpanel" aria-labelledby="tab-habits" aria-hidden="true">
            <h2>Ø§Ù„Ø¹Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©</h2>
            <div class="card">
                <h3>Ø¥Ø¶Ø§ÙØ© Ø¹Ø§Ø¯Ø©</h3>
                <input type="text" id="habitName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ø¯Ø©">
                <button class="btn btn-primary" id="addHabitBtn">Ø¥Ø¶Ø§ÙØ©</button>
            </div>
            <div class="grid-3" id="habitsContainer"></div>
        </section>

        <section id="stats" class="content-section" role="tabpanel" aria-labelledby="tab-stats" aria-hidden="true">
            <h2>Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h2>
            <div class="stat-grid">
                <div class="card stat-card">
                    <h3>Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…Ù†Ø¬Ø²Ø©</h3>
                    <div class="chart-container">
                        <canvas id="tasksChart"></canvas>
                        <div class="chart-percent" id="tasksChartPercent" style="color: var(--primary-color);">0%</div>
                    </div>
                    <span id="tasksChartLabel">0 / 0 Ù…Ù‡Ù…Ø©</span>
                </div>
                <div class="card stat-card">
                    <h3>Ù†Ø¬Ø§Ø­ Ø§Ù„Ø¹Ø§Ø¯Ø§Øª (Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ)</h3>
                    <div class="chart-container">
                        <canvas id="habitsChart"></canvas>
                        <div class="chart-percent" id="habitsChartPercent" style="color: var(--secondary-color);">0%</div>
                    </div>
                    <span id="habitsChartLabel">0 / 0 Ø¥Ù†Ø¬Ø§Ø²</span>
                </div>
            </div>
             <div class="card stat-card">
                <h3>Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„Ø£Ù‡Ø¯Ø§Ù Ø§Ù„Ù…Ø§Ù„ÙŠØ©</h3>
                <div class="chart-container">
                    <canvas id="financialChart"></canvas>
                    <div class="chart-percent" id="financialChartPercent" style="color: var(--primary-color);">0%</div>
                </div>
                <span id="financialChartLabel">0 / 0 Ø±ÙŠØ§Ù„</span>
            </div>
            <div class="card stat-card">
                <h3>ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª (Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±)</h3>
                <div class="chart-container" style="width: 200px; height: 200px;">
                    <canvas id="expensesChart"></canvas>
                </div>
                <div id="expensesLegend" style="margin-top: 20px; font-size: 0.9em;"></div>
            </div>
            <div class="card" id="uberArchiveContainer">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h2>Ø£Ø±Ø´ÙŠÙ Ø£ÙˆØ¨Ø±</h2>
                    <button class="btn btn-danger" id="clearArchiveBtn" style="margin-top:0; width: auto; padding: 10px 15px; font-size: 0.9em;">ØªØµÙÙŠØ± Ø§Ù„Ø£Ø±Ø´ÙŠÙ</button>
                </div>
                <div id="uberArchiveList"></div>
            </div>
        </section>

        <section id="backup" class="content-section" role="tabpanel" aria-labelledby="tab-backup" aria-hidden="true">
            <h2>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ</h2>
            
            <div class="card">
                <h3>Ù…ØµØ§Ø¯Ø± Ø§Ù„Ø¯Ø®Ù„ Ø§Ù„Ù…ØªÙƒØ±Ø±Ø© (Ù‚ÙˆØ§Ù„Ø¨)</h3>
                <p style="color: var(--text-light); line-height: 1.6; margin-top: -15px;">
                    Ø³Ø¬Ù„ Ù…ØµØ§Ø¯Ø± Ø¯Ø®Ù„Ùƒ Ø§Ù„Ù…ØªÙƒØ±Ø±Ø© (Ø±Ø§ØªØ¨ØŒ Ø¥ÙŠØ¬Ø§Ø±...) Ù„ØªØ¸Ù‡Ø± Ù„Ùƒ Ø¨Ø¯Ø§ÙŠØ© ÙƒÙ„ Ø´Ù‡Ø±.
                </p>
                <div id="incomeSourcesContainer" style="margin-bottom: 20px;"></div>
                <div style="display:flex; gap:10px; margin-bottom: 15px;">
                    <input type="text" id="newIncomeSource" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ØµØ¯Ø± (Ø±Ø§ØªØ¨ØŒ Ø¥ÙŠØ¬Ø§Ø±...)" style="margin-bottom:0;">
                    <input type="number" id="newIncomeAmount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" min="1" style="margin-bottom:0; flex-basis: 150px;">
                </div>
                <button class="btn btn-primary" id="addIncomeSourceBtn">Ø¥Ø¶Ø§ÙØ© Ù…ØµØ¯Ø± Ù…ØªÙƒØ±Ø±</button>
            </div>
            
            <div class="card">
                <h3>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø±Ø§ØªØ¨</h3>
                <label for="configSalaryDay">ÙŠÙˆÙ… Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø§Ù„ÙŠ (ÙŠÙˆÙ… Ù†Ø²ÙˆÙ„ Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ)</label>
                <input type="number" id="configSalaryDay" min="1" max="31">
                <button class="btn btn-primary" id="saveSalaryConfigBtn">Ø­ÙØ¸ ÙŠÙˆÙ… Ø§Ù„Ø±Ø§ØªØ¨</button>
            </div>

            <div class="card">
                <h3>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø£ÙˆØ¨Ø±</h3>
                <label for="configUberGoal">Ø§Ù„Ù‡Ø¯Ù Ø§Ù„ÙŠÙˆÙ…ÙŠ (ØµØ§ÙÙŠ)</label>
                <input type="number" id="configUberGoal" min="1">
                <label for="configUberCommission">Ù†Ø³Ø¨Ø© Ø¹Ù…ÙˆÙ„Ø© Ø£ÙˆØ¨Ø± (Ù…Ø«Ø§Ù„: 0.35 Ù„Ù„Ù€ 35%)</label>
                <input type="number" id="configUberCommission" min="0.01" max="0.99" step="0.01">
                <button class="btn btn-primary" id="saveUberConfigBtn">Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø£ÙˆØ¨Ø±</button>
            </div>

            <div class="card">
                <h3>Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ</h3>
                <p>Ø§Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø£Ùˆ Ø§Ø³ØªØ±Ø¬Ø¹Ù‡Ø§ Ù…Ù† Ù…Ù„Ù.</p>
                <div class="backup-section" style="display:flex; gap:10px; flex-wrap:wrap;">
                    <button class="btn btn-primary" id="exportDataBtn" style="width: auto;">ğŸ“¥ ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
                    <button class="btn btn-secondary" id="importDataBtn" style="width: auto;">ğŸ“¤ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
                    <input type="file" id="importFile" accept=".json" style="display:none">
                </div>
            </div>
            <div class="card">
                <h3>âš ï¸ Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>
                <p>Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹.</p>
                <button class="btn btn-danger" id="clearAllDataBtn" style="width: auto;">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„ÙƒÙ„</button>
            </div>
        </section>
    </div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// =================================================================
// Life Dashboard v10.1 (Hotfix)
// âœ… Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¨Ù‚ Ø§Ù„Ù„ÙŠ ÙŠØ®Ù„ÙŠ Ø²Ø± "Ø§Ù„Ø¥Ø¶Ø§ÙØ©" ÙŠØ¹Ù„Ù‚
// âœ¨ Ø¥Ø¶Ø§ÙØ© Ø²Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ (âœï¸) Ù„ÙƒÙ„ Ø§Ù„Ø¹Ù†Ø§ØµØ±
// ğŸ›¡ï¸ Ø¥Ø¶Ø§ÙØ© ØµÙ†Ø§Ø¯ÙŠÙ‚ Ø§Ù„Ø§Ø¯Ø®Ø§Ø±
// ğŸš€ Ø¥Ø¶Ø§ÙØ© Ø£ÙˆÙ„ÙˆÙŠØ© Ø§Ù„Ù…Ù‡Ø§Ù…
// ğŸ“Š Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ù… ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª
// =================================================================

document.addEventListener('DOMContentLoaded', () => {
    
    // #region --- Type Definitions ---
    /**
     * @typedef {Object} Goal
     * @property {string} id
     * @property {string} name
     * @property {number} target
     * @property {number} current
     * @property {string} dueDate
     */
    
    /**
     * @typedef {Object} Task
     * @property {string} id
     * @property {string} name
     * @property {string} dueDate
     * @property {string} priority ('high', 'medium', 'low')
     * @property {boolean} completed
     */
    
    /**
     * @typedef {Object} Project
     * @property {string} id
     * @property {string} name
     * @property {Task[]} tasks
     */

    /**
     * @typedef {Object} Habit
     * @property {string} id
     * @property {string} name
     * @property {number[]} completedDays
     * @property {number[]} failedDays
     * @property {number} lastWeekStart
     */
    
    /**
     * @typedef {Object} SinkingFund
     * @property {string} id
     * @property {string} name
     * @property {number} target
     * @property {number} current
     * @property {string} dueDate
     * @property {number} monthlyAmount
     * @property {string} linkedCategoryId
     */

    /**
     * @typedef {Object} BudgetCategory
     * @property {string} id
     * @property {string} name
     * @property {number} monthlyBudget
     * @property {number} currentSpent
     * @property {boolean} isSinkingFund
     */

    /** @typedef {Object} SalaryReset */
    /** @typedef {Object} OneTimeIncome */
    
    /**
     * @typedef {Object} SalaryData
     * @property {BudgetCategory[]} categories
     * @property {SalaryReset} lastReset
     * @property {string[]} expectedIncomeIds
     * @property {OneTimeIncome[]} oneTimeIncomes
     */

    /**
     * @typedef {Object} IncomeSource
     * @property {string} id
     * @property {string} name
     * @property {number} amount
     */
     
    /** @typedef {Object} UberRide */
    /** @typedef {Object} UberExpense */
    /** @typedef {Object} UberDay */

    /**
     * @typedef {Object} AppState
     * @property {Goal[]} goals
     * @property {Project[]} projects
     * @property {Habit[]} habits
     * @property {SinkingFund[]} sinkingFunds
     * @property {SalaryData} salary
     * @property {IncomeSource[]} incomeTemplates
     * @property {{ today: UberDay, archive: UberDay[] }} uber
     */

    /** @typedef {Object} AppConfig */
    // #endregion

    const App = {
        
        // --- 1. STATE & CONFIG ---
        
        /** @type {AppState} */
        state: {
            goals: [],
            projects: [],
            habits: [],
            sinkingFunds: [],
            salary: { 
                categories: [], 
                lastReset: { year: 2020, month: 0 },
                expectedIncomeIds: [],
                oneTimeIncomes: []
            },
            incomeTemplates: [],
            uber: { 
                today: { date: '', netProfitToday: 0, rides: [], generalExpenses: [] }, 
                archive: [] 
            }
        },
        
        /** @type {AppConfig} */
        config: {
            uberGoal: 150,
            uberCommission: 0.35,
            salaryStartDay: 27
        },
        
        domCache: {},
        charts: {},
        saveTimeout: null,
        lastSelectedProjectId: null,
        
        // --- Storage Keys ---
        OLD_KEYS: {
            state_v9: 'dashboardState_v9',
            config_v9: 'dashboardConfig_v9',
            state_v8: 'dashboardState_v8', // (Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªØ±Ø­ÙŠÙ„)
            config_v8: 'dashboardConfig_v8'
        },
        NEW_KEYS: {
            state: 'dashboardState_v10', // Ù†Ø³ØªØ®Ø¯Ù… v10 Ù„Ø£Ù† Ø§Ù„Ù‡ÙŠÙƒÙ„ Ù„Ù… ÙŠØªØºÙŠØ±
            config: 'dashboardConfig_v10'
        },
        
        // --- 2. CORE METHODS (Init, Load, Save) ---

        init() {
            this.utils.cacheDOM();
            this.runMigrations(); 
            this.loadStateAndConfig();
            this.initSalaryMonth(); 
            this.initUberDay();
            this.bindEventListeners();
            this.renderAll();
            this.utils.show('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ù†Ø¬Ø§Ø­! ğŸ‰', 'success');
        },

        debouncedSave() {
            clearTimeout(this.saveTimeout);
            this.saveTimeout = setTimeout(() => {
                localStorage.setItem(this.NEW_KEYS.state, JSON.stringify(this.state));
            }, 1000); 
        },

        saveConfig() {
            localStorage.setItem(this.NEW_KEYS.config, JSON.stringify(this.config));
        },
        
        loadStateAndConfig() {
            try {
                const storedState = localStorage.getItem(this.NEW_KEYS.state);
                if (storedState) {
                    const parsedState = JSON.parse(storedState);
                    this.state = { ...this.state, ...parsedState };
                    this.state.salary = { ...this.state.salary, ...(parsedState.salary || {}) };
                    this.state.uber = { ...this.state.uber, ...(parsedState.uber || {}) };
                    this.state.projects = parsedState.projects || [];
                    this.state.sinkingFunds = parsedState.sinkingFunds || [];
                    this.state.salary.lastReset = parsedState.salary?.lastReset || { year: 2020, month: 0 };
                    this.state.salary.expectedIncomeIds = parsedState.salary?.expectedIncomeIds || [];
                    this.state.salary.oneTimeIncomes = parsedState.salary?.oneTimeIncomes || [];
                    this.state.habits = parsedState.habits || [];
                    this.state.incomeTemplates = parsedState.incomeTemplates || [];
                }
            } catch (e) {
                console.error("Failed to parse state:", e);
                this.utils.show('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©ØŒ Ù‚Ø¯ ÙŠØªÙ… ÙÙ‚Ø¯Ø§Ù† Ø¨Ø¹Ø¶Ù‡Ø§.', 'error');
            }
            
            try {
                const storedConfig = localStorage.getItem(this.NEW_KEYS.config);
                if (storedConfig) {
                    this.config = { ...this.config, ...JSON.parse(storedConfig) };
                }
            } catch (e) { console.error("Failed to parse config:", e); }
            
            this.domCache.configUberGoal.value = this.config.uberGoal;
            this.domCache.configUberCommission.value = this.config.uberCommission;
            this.domCache.configSalaryDay.value = this.config.salaryStartDay;
        },
        
        runMigrations() {
            if (localStorage.getItem(this.NEW_KEYS.state)) {
                return; // Already on v10
            }
            
            // ØªØ±Ø­ÙŠÙ„ Ù…Ù† v9 (Ø£Ùˆ v8)
            const old_state_str = localStorage.getItem(this.OLD_KEYS.state_v9) || localStorage.getItem(this.OLD_KEYS.state_v8);
            const old_config_str = localStorage.getItem(this.OLD_KEYS.config_v9) || localStorage.getItem(this.OLD_KEYS.config_v8);
            
            if (old_state_str && old_config_str) {
                const oldState = JSON.parse(old_state_str);
                const oldConfig = JSON.parse(old_config_str);

                // Ø¥Ø¶Ø§ÙØ© Ù…ØµÙÙˆÙØ© ØµÙ†Ø§Ø¯ÙŠÙ‚ Ø§Ù„Ø§Ø¯Ø®Ø§Ø±
                oldState.sinkingFunds = oldState.sinkingFunds || [];
                
                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© Ù„Ù„Ù…Ù‡Ø§Ù…
                oldState.projects = (oldState.projects || []).map(p => ({
                    ...p,
                    tasks: (p.tasks || []).map(t => ({ ...t, priority: t.priority || 'medium' }))
                }));
                
                localStorage.setItem(this.NEW_KEYS.state, JSON.stringify(oldState));
                localStorage.setItem(this.NEW_KEYS.config, JSON.stringify(oldConfig));
                
                localStorage.removeItem(this.OLD_KEYS.state_v9);
                localStorage.removeItem(this.OLD_KEYS.config_v9);
                localStorage.removeItem(this.OLD_KEYS.state_v8);
                localStorage.removeItem(this.OLD_KEYS.config_v8);
                
                this.utils.show('ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¥Ù„Ù‰ Ø§Ù„Ø¥ØµØ¯Ø§Ø± 10.0 Pro! ğŸ‰', 'success');
                return;
            }
        },

        bindEventListeners() {
            this.utils.qs('.tabs').addEventListener('click', e => this.handlers.switchTab(e));
            this.domCache.addGoalBtn.addEventListener('click', e => this.handlers.addGoal(e));
            this.domCache.goalsContainer.addEventListener('click', e => this.handlers.handleGoalClick(e));
            this.domCache.addCategoryBtn.addEventListener('click', e => this.handlers.addSalaryCategory(e));
            this.domCache.budgetTrackerContainer.addEventListener('click', e => this.handlers.handleBudgetClick(e));
            this.domCache.addIncomeSourceBtn.addEventListener('click', e => this.handlers.addIncomeTemplate(e));
            this.domCache.incomeSourcesContainer.addEventListener('click', e => this.handlers.handleIncomeTemplateClick(e));
            this.domCache.incomeReceivedContainer.addEventListener('click', e => this.handlers.handleIncomeToggle(e));
            this.domCache.addOneTimeIncomeBtn.addEventListener('click', e => this.handlers.addOneTimeIncome(e));
            this.domCache.saveSalaryConfigBtn.addEventListener('click', e => this.handlers.saveSalaryConfig(e));
            // Sinking Funds
            this.domCache.addFundBtn.addEventListener('click', e => this.handlers.addSinkingFund(e));
            this.domCache.sinkingFundsContainer.addEventListener('click', e => this.handlers.handleFundClick(e));
            // Uber
            this.domCache.addRideBtn.addEventListener('click', e => this.handlers.addUberRide(e));
            this.domCache.addGeneralExpenseBtn.addEventListener('click', e => this.handlers.addGeneralExpense(e));
            this.domCache.endUberDayBtn.addEventListener('click', e => this.handlers.endUberDay(e));
            this.domCache.ridesHistoryContainer.addEventListener('click', e => this.handlers.handleUberHistoryClick(e));
            this.domCache.generalExpensesHistoryContainer.addEventListener('click', e => this.handlers.handleUberHistoryClick(e));
            // Tasks
            this.domCache.addProjectBtn.addEventListener('click', e => this.handlers.addProject(e));
            this.domCache.addTaskBtn.addEventListener('click', e => this.handlers.addTask(e));
            this.domCache.projectsContainer.addEventListener('click', e => this.handlers.handleProjectClick(e));
            this.domCache.taskProjectSelect.addEventListener('change', e => {
                this.lastSelectedProjectId = e.target.value;
            });
            // Habits
            this.domCache.addHabitBtn.addEventListener('click', e => this.handlers.addHabit(e));
            this.domCache.habitsContainer.addEventListener('click', e => this.handlers.handleHabitClick(e));
            // Stats
            this.domCache.clearArchiveBtn.addEventListener('click', e => this.handlers.clearUberArchive(e));
            this.domCache.uberArchiveList.addEventListener('click', e => this.handlers.showArchiveDetail(e));
            this.domCache.modalCloseBtn.addEventListener('click', () => this.domCache.archiveModal.style.display = 'none');
            this.domCache.archiveModal.addEventListener('click', e => {
                if (e.target === this.domCache.archiveModal) {
                    this.domCache.archiveModal.style.display = 'none';
                }
            });
            // Settings
            this.domCache.saveUberConfigBtn.addEventListener('click', e => this.handlers.saveUberConfig(e));
            this.domCache.exportDataBtn.addEventListener('click', () => this.handlers.exportData());
            this.domCache.importDataBtn.addEventListener('click', () => this.domCache.importFile.click());
            this.domCache.importFile.addEventListener('change', e => this.handlers.importData(e));
            this.domCache.clearAllDataBtn.addEventListener('click', () => this.handlers.clearAllData());
        },

        // --- 3. RENDER METHODS (View Logic) ---

        renderAll() {
            this.renderIncomeTemplates();
            this.renderGoals();
            this.renderSalary();
            this.renderSinkingFunds();
            this.renderUber();
            this.renderProjectsAndTasks();
            this.renderHabits();
        },
        
        renderGoals() {
            const container = this.domCache.goalsContainer;
            if (this.state.goals.length === 0) {
                container.innerHTML = `<div class="empty-state">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù‡Ø¯Ø§Ù Ù…Ø§Ù„ÙŠØ©. Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ø¶Ø§ÙØ© Ù‡Ø¯Ù Ø¬Ø¯ÙŠØ¯!</div>`;
                return;
            }
            let html = '';
            this.state.goals.forEach(g => {
                html += this.builders.goalCard(g, true);
            });
            container.innerHTML = html;
        },

        renderSalary() {
            const { categories, expectedIncomeIds, oneTimeIncomes } = this.state.salary;

            // --- 0. Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ Ù„Ù„Ø±Ø§ØªØ¨ ---
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const salaryDay = App.config.salaryStartDay;
            App.domCache.salaryDayLabel.textContent = salaryDay;
            let nextSalaryDate = new Date(today.getFullYear(), today.getMonth(), salaryDay);
            nextSalaryDate.setHours(0, 0, 0, 0);
            if (today.getTime() >= nextSalaryDate.getTime()) {
                nextSalaryDate.setMonth(nextSalaryDate.getMonth() + 1);
            }
            const diffTime = nextSalaryDate.getTime() - today.getTime();
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            let daysText = `${diffDays} Ø£ÙŠØ§Ù…`;
            if (diffDays === 0) daysText = "Ø§Ù„ÙŠÙˆÙ…! ğŸ‰";
            else if (diffDays === 1) daysText = "ØºØ¯Ø§Ù‹";
            else if (diffDays === 2) daysText = "ÙŠÙˆÙ…Ø§Ù†";
            App.domCache.daysUntilSalaryDisplay.textContent = daysText;

            // 1. Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¯Ø®Ù„ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹
            let totalExpectedIncome = 0;
            this.state.incomeTemplates.forEach(src => {
                if (expectedIncomeIds.includes(src.id)) {
                    totalExpectedIncome += src.amount;
                }
            });
            oneTimeIncomes.forEach(src => {
                totalExpectedIncome += src.amount;
            });
            this.domCache.totalExpectedIncomeDisplay.textContent = this.utils.fmt(totalExpectedIncome);

            // 2. Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¯Ø®Ù„ Ø§Ù„Ù…Ø³ØªÙ„Ù… (ÙÙ‚Ø· Ø§Ù„Ø¯Ø®Ù„ Ù„Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©)
            // ******** Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ù…Ø³Ø¨Ø¨ Ù„Ù„Ù…Ø´ÙƒÙ„Ø© ********
            // const totalReceivedIncome = oneTimeIncomes.reduce((acc, src) => acc + src.amount, 0);
            // this.domCache.totalReceivedIncomeDisplay.textContent = this.utils.fmt(totalReceivedIncome);
            // ***************************************

            // 3. Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…Ø®ØµØµ
            const totalAllocated = categories.reduce((acc, cat) => acc + cat.monthlyBudget, 0);
            this.domCache.totalAllocatedDisplay.textContent = this.utils.fmt(totalAllocated);
            
            // 4. Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù„Ù„ØªÙˆØ²ÙŠØ¹
            const unallocated = totalExpectedIncome - totalAllocated;
            this.domCache.unallocatedAmountDisplay.textContent = this.utils.fmt(unallocated);
            let unallocatedClass = 'neutral';
            if (unallocated > 0) unallocatedClass = 'positive';
            if (unallocated < 0) unallocatedClass = 'negative';
            this.domCache.unallocatedAmountDisplay.className = `value ${unallocatedClass}`;
            
            // 5. Ø±Ø³Ù… ÙƒØ±Øª Ø§Ù„Ø¯Ø®Ù„ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹
            const incomeReceivedContainer = this.domCache.incomeReceivedContainer;
            if(this.state.incomeTemplates.length === 0 && oneTimeIncomes.length === 0) {
                incomeReceivedContainer.innerHTML = `<p style="color:#777;">Ù„Ù… ØªÙ‚Ù… Ø¨Ø¥Ø¶Ø§ÙØ© Ù…ØµØ§Ø¯Ø± Ø¯Ø®Ù„. Ø§Ø°Ù‡Ø¨ Ù„Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª âš™ï¸</p>`;
            } else {
                let incomeHtml = '';
                this.state.incomeTemplates.forEach(src => {
                    const isExpected = expectedIncomeIds.includes(src.id);
                    incomeHtml += this.builders.incomeExpectedItem(src, isExpected, true);
                });
                oneTimeIncomes.forEach(src => {
                    incomeHtml += this.builders.oneTimeIncomeItem(src, true);
                });
                incomeReceivedContainer.innerHTML = incomeHtml;
            }

            // 6. Ø±Ø³Ù… ÙƒØ±ÙˆØª Ø§Ù„ÙØ¦Ø§Øª
            const container = this.domCache.budgetTrackerContainer;
            if (categories.length === 0) {
                container.innerHTML = `<div class="empty-state">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØ¦Ø§Øª Ù„Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©. Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ø¶Ø§ÙØ© ÙØ¦Ø© Ø¬Ø¯ÙŠØ¯Ø©.</div>`;
                return;
            }
            let html = '';
            categories.forEach(cat => {
                html += this.builders.salaryTrackerCard(cat, true);
            });
            container.innerHTML = html;
        },
        
        renderSinkingFunds() {
            const container = this.domCache.sinkingFundsContainer;
            if (this.state.sinkingFunds.length === 0) {
                container.innerHTML = `<div class="empty-state">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙ†Ø§Ø¯ÙŠÙ‚ Ø§Ø¯Ø®Ø§Ø±. Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ø¶Ø§ÙØ© ØµÙ†Ø¯ÙˆÙ‚ Ø¬Ø¯ÙŠØ¯!</div>`;
                return;
            }
            let html = '';
            this.state.sinkingFunds.forEach(f => {
                html += this.builders.sinkingFundCard(f, true);
            });
            container.innerHTML = html;
        },
        
        renderIncomeTemplates() {
            const container = this.domCache.incomeSourcesContainer;
            if (this.state.incomeTemplates.length === 0) {
                container.innerHTML = `<p style="color:#777;">Ù„Ù… ØªÙ‚Ù… Ø¨Ø¥Ø¶Ø§ÙØ© Ù…ØµØ§Ø¯Ø± Ø¯Ø®Ù„ Ù…ØªÙƒØ±Ø±Ø© Ø¨Ø¹Ø¯.</p>`;
                return;
            }
            let html = '';
            this.state.incomeTemplates.forEach(src => {
                html += this.builders.incomeSourceItem(src, true);
            });
            container.innerHTML = html;
        },

        renderUber() {
            const { today } = this.state.uber;
            const { uberGoal, uberCommission } = this.config;
            let net = 0;
            today.rides.forEach(r => net += r.net);
            today.generalExpenses.forEach(e => net -= e.amount);
            today.netProfitToday = net;
            const remaining = Math.max(0, uberGoal - today.netProfitToday);
            const grossNeeded = remaining > 0 ? remaining / (1 - uberCommission) : 0;
            this.domCache.uberTitle.textContent = `Ù‡Ø¯Ù Ø£ÙˆØ¨Ø± Ø§Ù„ÙŠÙˆÙ…ÙŠ (${this.utils.fmt(uberGoal)})`;
            this.domCache.uberNetProfit.textContent = this.utils.fmt(today.netProfitToday);
            this.domCache.uberRemaining.textContent = this.utils.fmt(remaining);
            this.domCache.uberGrossNeeded.textContent = this.utils.fmt(grossNeeded);
            const ridesContainer = this.domCache.ridesHistoryContainer;
            let ridesHtml = '<h4 style="color:var(--primary-color)">Ø§Ù„Ù…Ø´Ø§ÙˆÙŠØ±:</h4>';
            if (today.rides.length === 0) ridesHtml += '<p style="font-size:0.9em;color:#777;">Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ù…Ø´Ø§ÙˆÙŠØ± Ø¨Ø¹Ø¯.</p>';
            today.rides.forEach((r, i) => { ridesHtml += this.builders.uberRideItem(r, i, true); });
            ridesContainer.innerHTML = ridesHtml;
            const expensesContainer = this.domCache.generalExpensesHistoryContainer;
            let expensesHtml = '<h4 style="color:var(--primary-color)">Ù…ØµØ±ÙˆÙØ§Øª Ø¹Ø§Ù…Ø©:</h4>';
            if (today.generalExpenses.length === 0) expensesHtml += '<p style="font-size:0.9em;color:#777;">Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ù…ØµØ±ÙˆÙØ§Øª Ø¹Ø§Ù…Ø© Ø¨Ø¹Ø¯.</p>';
            today.generalExpenses.forEach((e, i) => { expensesHtml += this.builders.uberExpenseItem(e, i, true); });
            expensesContainer.innerHTML = expensesHtml;
        },
        
        renderUberArchive() {
            const container = this.domCache.uberArchiveList;
            if (this.state.uber.archive.length === 0) {
                container.innerHTML = `<div class="empty-state" style="padding: 20px;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ÙŠØ§Ù… Ù…Ø¤Ø±Ø´ÙØ© Ø¨Ø¹Ø¯.</div>`;
                this.domCache.clearArchiveBtn.style.display = 'none';
                return;
            }
            this.domCache.clearArchiveBtn.style.display = 'block';
            let html = '';
            [...this.state.uber.archive].reverse().forEach(day => {
                html += this.builders.uberArchiveItem(day, true);
            });
            container.innerHTML = html;
        },

        renderProjectsAndTasks() {
            const container = this.domCache.projectsContainer;
            const select = this.domCache.taskProjectSelect;
            let containerHtml = '';
            let selectHtml = '';
            if (this.state.projects.length === 0) {
                container.innerHTML = `<div class="empty-state">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹. Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ø¶Ø§ÙØ© Ù…Ø´Ø±ÙˆØ¹ Ø¬Ø¯ÙŠØ¯ Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰.</div>`;
                select.innerHTML = '<option value="">Ø£ÙˆÙ„Ø§Ù‹ØŒ Ù‚Ù… Ø¨Ø¥Ø¶Ø§ÙØ© Ù…Ø´Ø±ÙˆØ¹</option>';
                this.domCache.addTaskBtn.disabled = true; 
                return;
            }
            this.domCache.addTaskBtn.disabled = false; 
            this.state.projects.forEach(p => {
                selectHtml += `<option value="${p.id}">${this.utils.escapeHTML(p.name)}</option>`;
                containerHtml += this.builders.projectCard(p, true);
            });
            container.innerHTML = containerHtml;
            select.innerHTML = selectHtml;
            if (this.lastSelectedProjectId && select.querySelector(`option[value="${this.lastSelectedProjectId}"]`)) {
                select.value = this.lastSelectedProjectId;
            } else if (this.state.projects.length > 0) {
                this.lastSelectedProjectId = this.state.projects[0].id;
                select.value = this.lastSelectedProjectId;
            }
        },

        renderHabits() {
            const container = this.domCache.habitsContainer;
            const weekStart = this.utils.getWeekStart(new Date()).getTime();
            if (this.state.habits.length === 0) {
                container.innerHTML = `<div class="empty-state" style="grid-column: 1 / -1;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ø§Ø¯Ø§Øª. Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ø¶Ø§ÙØ© Ø¹Ø§Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©!</div>`;
                return;
            }
            let html = '';
            let didReset = false;
            this.state.habits.forEach(h => {
                h.completedDays = h.completedDays || [];
                h.failedDays = h.failedDays || [];
                if (h.lastWeekStart < weekStart) {
                    h.completedDays = [];
                    h.failedDays = [];
                    h.lastWeekStart = weekStart;
                    didReset = true;
                }
                html += this.builders.habitCard(h, true);
            });
            container.innerHTML = html;
            if (didReset) {
                this.debouncedSave();
            }
        },
        
        renderStats() {
            let totalWeeklyGoal = 0;
            let totalWeeklyCompleted = 0;
            const weekStart = this.utils.getWeekStart(new Date()).getTime();
            this.state.habits.forEach(h => {
                h.completedDays = h.completedDays || [];
                h.failedDays = h.failedDays || [];
                if (h.lastWeekStart < weekStart) {
                    h.completedDays = [];
                    h.failedDays = [];
                    h.lastWeekStart = weekStart;
                }
                totalWeeklyGoal += 7;
                totalWeeklyCompleted += h.completedDays.length;
            });

            let totalTasks = 0, completedTasks = 0;
            this.state.projects.forEach(p => {
                totalTasks += p.tasks.length;
                completedTasks += p.tasks.filter(t => t.completed).length;
            });
            const tasksPercent = totalTasks > 0 ? ((completedTasks / totalTasks) * 100) : 0;
            
            const habitsPercent = totalWeeklyGoal > 0 ? ((totalWeeklyCompleted / totalWeeklyGoal) * 100) : 0;

            const totalTarget = this.state.goals.reduce((acc, x) => acc + x.target, 0);
            const totalCurrent = this.state.goals.reduce((acc, x) => acc + x.current, 0);
            const financialPercent = totalTarget > 0 ? ((totalCurrent / totalTarget) * 100) : 0;

            this.domCache.tasksChartPercent.textContent = `${tasksPercent.toFixed(0)}%`;
            this.domCache.tasksChartLabel.textContent = `${completedTasks} / ${totalTasks} Ù…Ù‡Ù…Ø©`;
            this.domCache.habitsChartPercent.textContent = `${habitsPercent.toFixed(0)}%`;
            this.domCache.habitsChartLabel.textContent = `${totalWeeklyCompleted} / ${totalWeeklyGoal} Ø¥Ù†Ø¬Ø§Ø²`;
            this.domCache.financialChartPercent.textContent = `${financialPercent.toFixed(0)}%`;
            this.domCache.financialChartLabel.textContent = `${this.utils.fmt(totalCurrent)} / ${this.utils.fmt(totalTarget)}`;
            this.utils.createDonutChart('tasksChart', tasksPercent, 'var(--primary-color)');
            this.utils.createDonutChart('habitsChart', habitsPercent, 'var(--secondary-color)');
            this.utils.createDonutChart('financialChart', financialPercent, 'var(--primary-color)');
            
            this.renderExpensesChart();
            this.renderUberArchive();
        },
        
        renderExpensesChart() {
            const categories = this.state.salary.categories.filter(c => !c.isSinkingFund);
            const totalSpent = categories.reduce((acc, c) => acc + c.currentSpent, 0);

            if (categories.length === 0 || totalSpent === 0) {
                const legend = this.utils.qs('#expensesLegend');
                legend.innerHTML = '<p style="color:#777; text-align:center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ±ÙˆÙØ§Øª Ù…Ø³Ø¬Ù„Ø© Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</p>';
                this.utils.createPieChart('expensesChart', [], [], []);
                return;
            }
            
            const labels = categories.map(c => c.name);
            const data = categories.map(c => c.currentSpent);
            const colors = [
                '#2979ff', '#00e676', '#ff3d00', '#ffab00', '#9c27b0',
                '#00bcd4', '#ff5722', '#4caf50', '#f44336', '#3f51b5'
            ];
            
            this.utils.createPieChart('expensesChart', labels, data, colors);
            
            const legend = this.utils.qs('#expensesLegend');
            let legendHtml = '';
            categories.forEach((c, i) => {
                if (c.currentSpent > 0) {
                    const percent = ((c.currentSpent / totalSpent) * 100).toFixed(1);
                    legendHtml += `
                        <div style="display:flex; justify-content:space-between; margin-bottom:8px; align-items:center;">
                            <div style="display:flex; align-items:center; gap:8px;">
                                <div style="width:15px; height:15px; background:${colors[i % colors.length]}; border-radius:3px;"></div>
                                <span>${this.utils.escapeHTML(c.name)}</span>
                            </div>
                            <span style="font-weight:600;">${this.utils.fmt(c.currentSpent)} (${percent}%)</span>
                        </div>
                    `;
                }
            });
            legend.innerHTML = legendHtml;
        },
        
        // --- 4. DATA LOGIC (Initializers) ---
        
        initUberDay() {
            const todayStr = this.utils.getToday();
            if (this.state.uber.today.date !== todayStr) {
                if (this.state.uber.today.date && (this.state.uber.today.rides.length > 0 || this.state.uber.today.generalExpenses.length > 0)) {
                    this.state.uber.archive.push(this.state.uber.today);
                }
                this.state.uber.today = {
                    date: todayStr, netProfitToday: 0,
                    rides: [], generalExpenses: []
                };
                this.debouncedSave();
            }
        },
        
        initSalaryMonth() {
            const today = new Date();
            const { salaryStartDay } = this.config;
            const { lastReset } = this.state.salary;
            const lastResetDate = new Date(lastReset.year, lastReset.month, 1); 
            let lastSalaryDayDate = new Date(today.getFullYear(), today.getMonth(), salaryStartDay);
            if (today < lastSalaryDayDate) {
                lastSalaryDayDate.setMonth(lastSalaryDayDate.getMonth() - 1);
            }
            if (lastResetDate.getFullYear() < lastSalaryDayDate.getFullYear() || 
                (lastResetDate.getFullYear() === lastSalaryDayDate.getFullYear() && lastResetDate.getMonth() < lastSalaryDayDate.getMonth())) 
            {
                this.state.salary.categories = this.state.salary.categories.map(cat => ({ ...cat, currentSpent: 0 }));
                this.state.salary.oneTimeIncomes = [];
                this.state.salary.expectedIncomeIds = this.state.incomeTemplates.map(src => src.id);
                this.state.salary.lastReset = { year: lastSalaryDayDate.getFullYear(), month: lastSalaryDayDate.getMonth() };
                
                this.state.sinkingFunds.forEach(fund => {
                    if (fund.linkedCategoryId) {
                        const cat = this.state.salary.categories.find(c => c.id === fund.linkedCategoryId);
                        if (cat) {
                            cat.monthlyBudget = fund.monthlyAmount;
                        }
                    }
                });
                
                this.debouncedSave();
                this.utils.show('ØªÙ… ØªØµÙÙŠØ± Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ù„Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯!', 'success');
            }
        },

        // --- 5. EVENT HANDLERS (Controllers) ---
        
        handlers: {
            
            switchTab(event) {
                const targetButton = event.target.closest('.tab-link');
                if (!targetButton) return;
                event.preventDefault();
                const targetId = targetButton.dataset.target;
                document.querySelectorAll('.tab-link').forEach(l => l.setAttribute('aria-selected', 'false'));
                targetButton.setAttribute('aria-selected', 'true');
                document.querySelectorAll('.content-section').forEach(s => {
                    s.classList.remove('active');
                    s.setAttribute('aria-hidden', 'true');
                });
                const targetSection = App.utils.qs(targetId);
                targetSection.classList.add('active');
                targetSection.setAttribute('aria-hidden', 'false');
                if (targetId === '#stats') {
                    App.renderStats();
                }
            },
            
            addGoal(e) {
                const btn = e.target; btn.disabled = true;
                const name = App.domCache.goalName.value.trim();
                const target = +App.domCache.goalAmount.value;
                const current = +App.domCache.currentSavings.value || 0;
                const dueDate = App.domCache.goalDueDate.value;
                if (!name) return App.utils.showError(btn, 'Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù‡Ø¯Ù.');
                if (App.state.goals.find(g => g.name === name)) return App.utils.showError(btn, 'Ù‡Ø°Ø§ Ø§Ù„Ù‡Ø¯Ù Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹.');
                if (!Number.isFinite(target) || target <= 0) return App.utils.showError(btn, 'Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº Ù…Ø³ØªÙ‡Ø¯Ù ØµØ­ÙŠØ­ (Ø£ÙƒØ¨Ø± Ù…Ù† ØµÙØ±).');
                if (!Number.isFinite(current) || current < 0) return App.utils.showError(btn, 'Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº Ø­Ø§Ù„ÙŠ ØµØ­ÙŠØ­ (ØµÙØ± Ø£Ùˆ Ø£ÙƒØ«Ø±).');
                const newGoal = { id: Date.now() + '', name, target, current, dueDate };
                App.state.goals.push(newGoal);
                App.debouncedSave();
                if (App.state.goals.length === 1) {
                    App.renderGoals(); 
                } else {
                    const goalEl = App.builders.goalCard(newGoal, true);
                    App.domCache.goalsContainer.insertAdjacentHTML('beforeend', goalEl);
                }
                App.domCache.goalName.value = '';
                App.domCache.goalAmount.value = '';
                App.domCache.currentSavings.value = '';
                App.domCache.goalDueDate.value = '';
                App.utils.show('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‡Ø¯Ù âœ…', 'success');
                btn.disabled = false;
            },
            
            handleGoalClick(e) {
                const card = e.target.closest('.card-goal');
                if (!card) return;
                const id = card.dataset.id;
                
                if (e.target.matches('.btn-edit-goal')) {
                    const goal = App.state.goals.find(g => g.id === id);
                    if (goal) {
                        const newName = prompt('ØªØ¹Ø¯ÙŠÙ„ Ø§Ø³Ù… Ø§Ù„Ù‡Ø¯Ù:', goal.name);
                        if (newName && newName.trim()) {
                            goal.name = newName.trim();
                            App.debouncedSave();
                            App.renderGoals();
                            App.utils.show('ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‡Ø¯Ù', 'success');
                        }
                    }
                }
                
                if (e.target.matches('.btn-delete-goal')) {
                    if (confirm('Ø­Ø°Ù Ø§Ù„Ù‡Ø¯ÙØŸ')) {
                        App.state.goals = App.state.goals.filter(g => g.id !== id);
                        App.debouncedSave();
                        card.remove();
                        if (App.state.goals.length === 0) App.renderGoals();
                        App.utils.show('ØªÙ… Ø§Ù„Ø­Ø°Ù', 'success');
                    }
                }
                if (e.target.matches('.btn-update-amount')) {
                    const amountInput = card.querySelector('.add-amount-input');
                    const amount = +amountInput.value;
                    if (!Number.isFinite(amount) || amount <= 0) return App.utils.showError(null, 'Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­ Ù„Ù„Ø¥Ø¶Ø§ÙØ©.');
                    const goal = App.state.goals.find(g => g.id === id);
                    if (goal) {
                        goal.current += amount;
                        App.debouncedSave();
                        amountInput.value = '';
                        const p = goal.target > 0 ? ((goal.current / goal.target) * 100) : 0;
                        card.querySelector('.current-value').textContent = App.utils.fmt(goal.current);
                        card.querySelector('.remaining-value').textContent = App.utils.fmt(goal.target - goal.current);
                        card.querySelector('.percent-value').textContent = `${p.toFixed(1)}%`;
                        card.querySelector('.progress-bar div').style.width = `${Math.min(100, p)}%`;
                        App.utils.show('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¨Ù„Øº âœ…', 'success');
                    }
                }
            },
            
            // --- Salary Handlers ---
            addIncomeTemplate(e) {
                const btn = e.target; btn.disabled = true;
                const nameInput = App.domCache.newIncomeSource;
                const amountInput = App.domCache.newIncomeAmount;
                const name = nameInput.value.trim();
                const amount = +amountInput.value;
                if (!name) return App.utils.showError(btn, 'Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…ØµØ¯Ø±');
                if (App.state.incomeTemplates.find(src => src.name === name)) return App.utils.showError(btn, 'Ù‡Ø°Ø§ Ø§Ù„Ù…ØµØ¯Ø± Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹.');
                if (!Number.isFinite(amount) || amount <= 0) return App.utils.showError(btn, 'Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­.');
                const newSource = { id: Date.now() + '', name, amount };
                App.state.incomeTemplates.push(newSource);
                App.state.salary.expectedIncomeIds.push(newSource.id);
                App.debouncedSave();
                App.renderIncomeTemplates();
                App.renderSalary();
                nameInput.value = '';
                amountInput.value = '';
                App.utils.show('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ù…ØµØ¯Ø± Ø§Ù„Ø¯Ø®Ù„ Ø§Ù„Ù…ØªÙƒØ±Ø±', 'success');
                btn.disabled = false;
            },

            handleIncomeTemplateClick(e) {
                const item = e.target.closest('.list-item');
                if (!item) return;
                const id = item.dataset.id;
                
                if (e.target.matches('.btn-edit-income')) {
                    const source = App.state.incomeTemplates.find(src => src.id === id);
                    if (source) {
                        const newName = prompt('ØªØ¹Ø¯ÙŠÙ„ Ø§Ø³Ù… Ø§Ù„Ù…ØµØ¯Ø±:', source.name);
                        const newAmountStr = prompt('ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¨Ù„Øº:', source.amount);
                        let changed = false;
                        if (newName && newName.trim()) {
                            source.name = newName.trim();
                            changed = true;
                        }
                        if (newAmountStr) {
                            const newAmount = +newAmountStr;
                            if (Number.isFinite(newAmount) && newAmount > 0) {
                                source.amount = newAmount;
                                changed = true;
                            } else {
                                App.utils.showError(null, 'Ø§Ù„Ù…Ø¨Ù„Øº ØºÙŠØ± ØµØ§Ù„Ø­.');
                            }
                        }
                        if (changed) {
                            App.debouncedSave();
                            App.renderIncomeTemplates();
                            App.renderSalary();
                            App.utils.show('ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ØµØ¯Ø±', 'success');
                        }
                    }
                }

                if (e.target.matches('.btn-delete-income')) {
                    if (confirm('Ø­Ø°Ù Ù…ØµØ¯Ø± Ø§Ù„Ø¯Ø®Ù„ØŸ')) {
                        App.state.incomeTemplates = App.state.incomeTemplates.filter(src => src.id !== id);
                        App.state.salary.expectedIncomeIds = App.state.salary.expectedIncomeIds.filter(i => i !== id);
                        App.debouncedSave();
                        item.remove();
                        if (App.state.incomeTemplates.length === 0) App.renderIncomeTemplates();
                        App.renderSalary();
                        App.utils.show('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…ØµØ¯Ø±', 'success');
                    }
                }
            },
            
            handleIncomeToggle(e) {
                const item = e.target.closest('.income-list-item');
                if (!item) return;
                
                if(e.target.matches('.income-expected-checkbox')) {
                    const id = item.dataset.id;
                    const isChecked = e.target.checked;
                    if (isChecked) {
                        if (!App.state.salary.expectedIncomeIds.includes(id)) {
                            App.state.salary.expectedIncomeIds.push(id);
                        }
                    } else {
                        App.state.salary.expectedIncomeIds = App.state.salary.expectedIncomeIds.filter(i => i !== id);
                    }
                    App.debouncedSave();
                    App.renderSalary();
                }
                
                if(e.target.matches('.btn-delete-onetime')) {
                    const id = item.dataset.id;
                    if (confirm('Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¯Ø®Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØŸ')) {
                        App.state.salary.oneTimeIncomes = App.state.salary.oneTimeIncomes.filter(src => src.id !== id);
                        App.debouncedSave();
                        App.renderSalary();
                        App.utils.show('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¯Ø®Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ', 'success');
                    }
                }
            },
            
            addOneTimeIncome(e) {
                const btn = e.target; btn.disabled = true;
                const nameInput = App.domCache.oneTimeIncomeName;
                const amountInput = App.domCache.oneTimeIncomeAmount;
                const name = nameInput.value.trim();
                const amount = +amountInput.value;
                if (!name) return App.utils.showError(btn, 'Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…ØµØ¯Ø±');
                if (!Number.isFinite(amount) || amount <= 0) return App.utils.showError(btn, 'Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­.');
                const newIncome = { id: Date.now() + '', name, amount };
                App.state.salary.oneTimeIncomes.push(newIncome);
                App.debouncedSave();
                App.renderSalary();
                nameInput.value = '';
                amountInput.value = '';
                App.utils.show('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯Ø®Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ', 'success');
                btn.disabled = false;
            },

            addSalaryCategory(e) {
                const btn = e.target; btn.disabled = true;
                const nameInput = App.domCache.newCategoryName;
                const name = nameInput.value.trim();
                if (!name) return App.utils.showError(btn, 'Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ù„Ù„ÙØ¦Ø©');
                if (App.state.salary.categories.find(c => c.name === name)) return App.utils.showError(btn, 'Ù‡Ø°Ù‡ Ø§Ù„ÙØ¦Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹.');
                const newCategory = { id: Date.now() + '', name, monthlyBudget: 0, currentSpent: 0, isSinkingFund: false };
                App.state.salary.categories.push(newCategory);
                App.debouncedSave();
                if (App.state.salary.categories.length === 1) {
                    App.renderSalary();
                } else {
                    const catEl = App.builders.salaryTrackerCard(newCategory, true);
                    App.domCache.budgetTrackerContainer.insertAdjacentHTML('beforeend', catEl);
                }
                App.renderSalary();
                nameInput.value = '';
                App.utils.show('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØ¦Ø©', 'success');
                btn.disabled = false;
            },

            handleBudgetClick(e) {
                const card = e.target.closest('.salary-tracker-card');
                if (!card) return;
                const id = card.dataset.id;
                const category = App.state.salary.categories.find(c => c.id === id);
                if (!category) return;
                
                if (e.target.matches('.btn-edit-category')) {
                    if(category.isSinkingFund) return App.utils.showError(null, 'Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ Ø§Ø³Ù… ÙØ¦Ø© Ù…Ø±ØªØ¨Ø·Ø© Ø¨ØµÙ†Ø¯ÙˆÙ‚. Ø¹Ø¯Ù„ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ Ù†ÙØ³Ù‡.');
                    const newName = prompt('ØªØ¹Ø¯ÙŠÙ„ Ø§Ø³Ù… Ø§Ù„ÙØ¦Ø©:', category.name);
                    if (newName && newName.trim()) {
                        if (App.state.salary.categories.find(c => c.name === newName.trim() && c.id !== id)) {
                           return App.utils.showError(null, 'Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù… Ù„ÙØ¦Ø© Ø£Ø®Ø±Ù‰.');
                        }
                        category.name = newName.trim();
                        App.debouncedSave();
                        App.renderSalary();
                        App.utils.show('ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙØ¦Ø©', 'success');
                    }
                }

                if (e.target.matches('.btn-add-expense')) {
                    const amountInput = card.querySelector('.spend-input');
                    const amount = +amountInput.value;
                    if (!Number.isFinite(amount) || amount <= 0) return App.utils.showError(null, 'Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­ Ù„Ù„Ù…ØµØ±ÙˆÙ');
                    category.currentSpent += amount;
                    App.debouncedSave();
                    App.renderSalary(); 
                    App.utils.show(`ØªÙ… ØªØ³Ø¬ÙŠÙ„ ${App.utils.fmt(amount)}`, 'success');
                }
                if (e.target.matches('.budget-input')) {
                    if(category.isSinkingFund) return;
                    e.target.addEventListener('change', () => {
                        const budget = +e.target.value;
                        const validBudget = (Number.isFinite(budget) && budget >= 0) ? budget : 0;
                        category.monthlyBudget = validBudget;
                        App.debouncedSave();
                        App.renderSalary();
                    });
                }
                if (e.target.matches('.btn-delete-category')) {
                    if(category.isSinkingFund) return App.utils.showError(null, 'Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù ÙØ¦Ø© Ù…Ø±ØªØ¨Ø·Ø© Ø¨ØµÙ†Ø¯ÙˆÙ‚. Ø§Ø­Ø°Ù Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ Ø£ÙˆÙ„Ø§Ù‹.');
                    if (confirm(`Ø­Ø°Ù ÙØ¦Ø© "${category.name}"ØŸ`)) {
                        App.state.salary.categories = App.state.salary.categories.filter(c => c.id !== id);
                        App.debouncedSave();
                        App.renderSalary();
                        App.utils.show('ØªÙ… Ø­Ø°Ù Ø§Ù„ÙØ¦Ø©', 'success');
                    }
                }
            },
            
            saveSalaryConfig(e) {
                const btn = e.target; btn.disabled = true;
                const day = +App.domCache.configSalaryDay.value;
                if (!Number.isFinite(day) || day < 1 || day > 31) return App.utils.showError(btn, 'Ø£Ø¯Ø®Ù„ ÙŠÙˆÙ… ØµØ­ÙŠØ­ ÙÙŠ Ø§Ù„Ø´Ù‡Ø± (Ø¨ÙŠÙ† 1 Ùˆ 31).');
                App.config.salaryStartDay = day;
                App.saveConfig();
                App.initSalaryMonth(); 
                App.renderSalary();
                App.utils.show('ØªÙ… Ø­ÙØ¸ ÙŠÙˆÙ… Ø§Ù„Ø±Ø§ØªØ¨', 'success');
                btn.disabled = false;
            },

            addSinkingFund(e) {
                const btn = e.target; btn.disabled = true;
                const name = App.domCache.fundName.value.trim();
                const target = +App.domCache.fundTarget.value;
                const dueDate = App.domCache.fundDueDate.value;
                
                if (!name) return App.utils.showError(btn, 'Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚');
                if (App.state.sinkingFunds.find(f => f.name === name)) return App.utils.showError(btn, 'Ù‡Ø°Ø§ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹.');
                if (!Number.isFinite(target) || target <= 0) return App.utils.showError(btn, 'Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­.');
                if (!dueDate) return App.utils.showError(btn, 'Ø£Ø¯Ø®Ù„ ØªØ§Ø±ÙŠØ® Ù…Ø³ØªÙ‡Ø¯Ù.');
                
                const today = new Date();
                const due = new Date(dueDate);
                if (due <= today) return App.utils.showError(btn, 'Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† ÙÙŠ Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„.');
                
                const monthsDiff = Math.max(1, Math.round((due - today) / (1000 * 60 * 60 * 24 * 30.44)));
                const monthlyAmount = Math.ceil(target / monthsDiff);
                
                const newCategory = {
                    id: Date.now() + '_cat',
                    name: `ğŸ›¡ï¸ ${name}`,
                    monthlyBudget: monthlyAmount,
                    currentSpent: 0,
                    isSinkingFund: true
                };
                App.state.salary.categories.push(newCategory);
                
                const newFund = {
                    id: Date.now() + '',
                    name,
                    target,
                    current: 0,
                    dueDate,
                    monthlyAmount,
                    linkedCategoryId: newCategory.id
                };
                App.state.sinkingFunds.push(newFund);
                
                App.debouncedSave();
                App.renderSinkingFunds();
                App.renderSalary();
                
                App.domCache.fundName.value = '';
                App.domCache.fundTarget.value = '';
                App.domCache.fundDueDate.value = '';
                
                App.utils.show(`ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ØµÙ†Ø¯ÙˆÙ‚! Ø§Ø­ÙØ¸ ${App.utils.fmt(monthlyAmount)} Ø´Ù‡Ø±ÙŠØ§Ù‹`, 'success');
                btn.disabled = false;
            },

            handleFundClick(e) {
                const card = e.target.closest('.sinking-fund-card');
                if (!card) return;
                const id = card.dataset.id;
                
                if (e.target.matches('.btn-edit-fund')) {
                    const fund = App.state.sinkingFunds.find(f => f.id === id);
                    if (fund) {
                        const newName = prompt('ØªØ¹Ø¯ÙŠÙ„ Ø§Ø³Ù… Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚:', fund.name);
                        if (newName && newName.trim()) {
                            fund.name = newName.trim();
                            const linkedCat = App.state.salary.categories.find(c => c.id === fund.linkedCategoryId);
                            if (linkedCat) {
                                linkedCat.name = `ğŸ›¡ï¸ ${newName.trim()}`;
                            }
                            App.debouncedSave();
                            App.renderSinkingFunds();
                            App.renderSalary();
                            App.utils.show('ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚', 'success');
                        }
                    }
                }

                if (e.target.matches('.btn-delete-fund')) {
                    if (confirm('Ø­Ø°Ù Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ ÙˆØ§Ù„ÙØ¦Ø© Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡ØŸ')) {
                        const fund = App.state.sinkingFunds.find(f => f.id === id);
                        if (fund) {
                            App.state.salary.categories = App.state.salary.categories.filter(c => c.id !== fund.linkedCategoryId);
                            App.state.sinkingFunds = App.state.sinkingFunds.filter(f => f.id !== id);
                            App.debouncedSave();
                            App.renderSinkingFunds();
                            App.renderSalary();
                            App.utils.show('ØªÙ… Ø­Ø°Ù Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚', 'success');
                        }
                    }
                }

                if (e.target.matches('.btn-add-to-fund')) {
                    const amountInput = card.querySelector('.fund-add-input');
                    const amount = +amountInput.value;
                    if (!Number.isFinite(amount) || amount <= 0) return App.utils.showError(null, 'Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­.');
                    
                    const fund = App.state.sinkingFunds.find(f => f.id === id);
                    if (fund) {
                        fund.current = Math.min(fund.target, fund.current + amount);
                        App.debouncedSave();
                        App.renderSinkingFunds();
                        App.utils.show('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¨Ù„Øº Ù„Ù„ØµÙ†Ø¯ÙˆÙ‚ âœ…', 'success');
                    }
                }
            },

            addUberRide(e) {
                const btn = e.target; btn.disabled = true;
                const grossIncome = +App.domCache.rideIncome.value;
                const expense = +App.domCache.rideExpense.value || 0;
                if (!Number.isFinite(grossIncome) || grossIncome <= 0) return App.utils.showError(btn, 'Ø£Ø¯Ø®Ù„ Ø¯Ø®Ù„ Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØµØ­ÙŠØ­ Ù„Ù„Ù…Ø´ÙˆØ§Ø±.');
                if (!Number.isFinite(expense) || expense < 0) return App.utils.showError(btn, 'Ø£Ø¯Ø®Ù„ Ù…ØµØ±ÙˆÙ Ø¥Ø¶Ø§ÙÙŠ ØµØ­ÙŠØ­ (ØµÙØ± Ø£Ùˆ Ø£ÙƒØ«Ø±).');
                const commission = grossIncome * App.config.uberCommission;
                const net = grossIncome - commission - expense;
                const newRide = { id: Date.now() + '', grossIncome, commission, expense, net };
                App.state.uber.today.rides.push(newRide);
                App.debouncedSave();
                if (App.state.uber.today.rides.length === 1) App.domCache.ridesHistoryContainer.innerHTML = '<h4 style="color:var(--primary-color)">Ø§Ù„Ù…Ø´Ø§ÙˆÙŠØ±:</h4>';
                const rideEl = App.builders.uberRideItem(newRide, App.state.uber.today.rides.length - 1, true);
                App.domCache.ridesHistoryContainer.insertAdjacentHTML('beforeend', rideEl);
                App.renderUber(); 
                App.domCache.rideIncome.value = '';
                App.domCache.rideExpense.value = '';
                App.utils.show(`ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø´ÙˆØ§Ø±! ØµØ§ÙÙŠ: ${App.utils.fmt(net)}`, 'success');
                btn.disabled = false;
            },
            
            addGeneralExpense(e) {
                const btn = e.target; btn.disabled = true;
                const amount = +App.domCache.generalExpenseAmount.value;
                const name = App.domCache.generalExpenseName.value.trim() || 'Ù…ØµØ±ÙˆÙ Ø¹Ø§Ù…';
                if (!Number.isFinite(amount) || amount <= 0) return App.utils.showError(btn, 'Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­ Ù„Ù„Ù…ØµØ±ÙˆÙ.');
                const newExpense = { id: Date.now() + '', name, amount };
                App.state.uber.today.generalExpenses.push(newExpense);
                App.debouncedSave();
                if (App.state.uber.today.generalExpenses.length === 1) App.domCache.generalExpensesHistoryContainer.innerHTML = '<h4 style="color:var(--primary-color)">Ù…ØµØ±ÙˆÙØ§Øª Ø¹Ø§Ù…Ø©:</h4>';
                const expenseEl = App.builders.uberExpenseItem(newExpense, App.state.uber.today.generalExpenses.length - 1, true);
                App.domCache.generalExpensesHistoryContainer.insertAdjacentHTML('beforeend', expenseEl);
                App.renderUber(); 
                App.domCache.generalExpenseAmount.value = '';
                App.domCache.generalExpenseName.value = '';
                App.utils.show(`ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ù…ØµØ±ÙˆÙ ${App.utils.fmt(amount)}`, 'success');
                btn.disabled = false;
            },
            
            handleUberHistoryClick(e) {
                const item = e.target.closest('.list-item');
                if (!item) return;
                const id = item.dataset.id;
                if (e.target.matches('.btn-delete-ride')) {
                    App.state.uber.today.rides = App.state.uber.today.rides.filter(r => r.id !== id);
                    App.debouncedSave();
                    App.renderUber(); 
                    App.utils.show('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø´ÙˆØ§Ø±', 'success');
                }
                if (e.target.matches('.btn-delete-expense')) {
                    App.state.uber.today.generalExpenses = App.state.uber.today.generalExpenses.filter(e => e.id !== id);
                    App.debouncedSave();
                    App.renderUber(); 
                    App.utils.show('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…ØµØ±ÙˆÙ', 'success');
                }
            },
            
            endUberDay() {
                const net = App.state.uber.today.netProfitToday;
                if (confirm(`Ø¥Ù†Ù‡Ø§Ø¡ ÙŠÙˆÙ… Ø£ÙˆØ¨Ø±ØŸ Ø§Ù„ØµØ§ÙÙŠ ${App.utils.fmt(net)}. Ø³ÙŠØªÙ… Ø£Ø±Ø´ÙØ© Ø§Ù„ÙŠÙˆÙ… ÙˆØ¨Ø¯Ø¡ ÙŠÙˆÙ… Ø¬Ø¯ÙŠØ¯.`)) {
                    App.initUberDay(); 
                    App.renderUber();
                    App.utils.show('ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ ÙˆØ£Ø±Ø´ÙØ© Ø§Ù„ÙŠÙˆÙ…. ÙŠÙˆÙ… Ø¬Ø¯ÙŠØ¯ Ø³Ø¹ÙŠØ¯!', 'success');
                }
            },
            
            saveUberConfig(e) {
                const btn = e.target; btn.disabled = true;
                const goal = +App.domCache.configUberGoal.value;
                const commission = +App.domCache.configUberCommission.value;
                if (!Number.isFinite(goal) || goal <= 0) return App.utils.showError(btn, 'Ø£Ø¯Ø®Ù„ Ù‡Ø¯Ù ÙŠÙˆÙ…ÙŠ ØµØ­ÙŠØ­ (Ø£ÙƒØ¨Ø± Ù…Ù† ØµÙØ±).');
                if (!Number.isFinite(commission) || commission <= 0 || commission >= 1) return App.utils.showError(btn, 'Ø£Ø¯Ø®Ù„ Ù†Ø³Ø¨Ø© Ø¹Ù…ÙˆÙ„Ø© ØµØ­ÙŠØ­Ø© (Ø¨ÙŠÙ† 0.01 Ùˆ 0.99).');
                App.config.uberGoal = goal;
                App.config.uberCommission = commission;
                App.saveConfig();
                App.renderUber();
                App.utils.show('ØªÙ… Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø£ÙˆØ¨Ø±', 'success');
                btn.disabled = false;
            },

            addProject(e) {
                const btn = e.target; btn.disabled = true;
                const nameInput = App.domCache.projectName;
                const name = nameInput.value.trim();
                if (!name) return App.utils.showError(btn, 'Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ù„Ù„Ù…Ø´Ø±ÙˆØ¹.');
                if (App.state.projects.find(p => p.name === name)) return App.utils.showError(btn, 'Ù‡Ø°Ø§ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹.');
                const newProject = { id: Date.now() + '', name, tasks: [] };
                App.state.projects.push(newProject);
                App.debouncedSave();
                if (App.state.projects.length === 1) {
                    App.renderProjectsAndTasks(); 
                } else {
                    const projectEl = App.builders.projectCard(newProject, true);
                    App.domCache.projectsContainer.insertAdjacentHTML('beforeend', projectEl);
                    const optionEl = `<option value="${newProject.id}">${App.utils.escapeHTML(newProject.name)}</option>`;
                    App.domCache.taskProjectSelect.insertAdjacentHTML('beforeend', optionEl);
                }
                App.lastSelectedProjectId = newProject.id;
                App.domCache.taskProjectSelect.value = newProject.id;
                App.domCache.addTaskBtn.disabled = false;
                nameInput.value = '';
                App.utils.show('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ âœ…', 'success');
                btn.disabled = false;
            },

            addTask(e) {
                const btn = e.target; btn.disabled = true;
                const projectId = App.domCache.taskProjectSelect.value;
                const name = App.domCache.taskName.value.trim();
                const dueDate = App.domCache.taskDueDate.value;
                const priority = App.domCache.taskPriority.value;
                if (!projectId) return App.utils.showError(btn, 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø´Ø±ÙˆØ¹ Ø£ÙˆÙ„Ø§Ù‹.');
                if (!name || !dueDate) return App.utils.showError(btn, 'Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… ÙˆØªØ§Ø±ÙŠØ® Ù„Ù„Ù…Ù‡Ù…Ø©.');
                const project = App.state.projects.find(p => p.id === projectId);
                if (project) {
                    const newTask = { id: Date.now() + '', name, dueDate, priority, completed: false };
                    project.tasks.push(newTask);
                    App.debouncedSave();
                    const projectCard = App.utils.qs(`.project-card[data-project-id="${projectId}"]`);
                    const tasksContainer = projectCard.querySelector(`.tasks-list-for-project-${projectId}`);
                    let tasksHtml = '';
                    const sortedTasks = App.utils.sortTasks(project.tasks);
                    sortedTasks.forEach(t => {
                        tasksHtml += App.builders.taskCard(t, projectId, true);
                    });
                    tasksContainer.innerHTML = tasksHtml;
                    App.domCache.taskName.value = '';
                    App.domCache.taskDueDate.value = '';
                    App.domCache.taskPriority.value = 'medium';
                    App.utils.show('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù‡Ù…Ø© âœ…', 'success');
                } else {
                    App.utils.showError(btn, 'Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹.');
                }
                btn.disabled = false;
            },
            
            handleProjectClick(e) {
                const projectId = e.target.dataset.projectId;
                const taskId = e.target.dataset.taskId;
                
                if (e.target.matches('.btn-edit-project')) {
                    const project = App.state.projects.find(p => p.id === projectId);
                    if (project) {
                        const newName = prompt('ØªØ¹Ø¯ÙŠÙ„ Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹:', project.name);
                        if (newName && newName.trim()) {
                            if (App.state.projects.find(p => p.name === newName.trim() && p.id !== projectId)) {
                                return App.utils.showError(null, 'Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¢Ø®Ø±.');
                            }
                            project.name = newName.trim();
                            App.debouncedSave();
                            App.renderProjectsAndTasks();
                            App.utils.show('ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹', 'success');
                        }
                    }
                }
                
                if (e.target.matches('.btn-edit-task')) {
                    const project = App.state.projects.find(p => p.id === projectId);
                    if (project) {
                        const task = project.tasks.find(t => t.id === taskId);
                        if (task) {
                            const newName = prompt('ØªØ¹Ø¯ÙŠÙ„ Ø§Ø³Ù… Ø§Ù„Ù…Ù‡Ù…Ø©:', task.name);
                            if (newName && newName.trim()) {
                                task.name = newName.trim();
                                App.debouncedSave();
                                e.target.closest('.task-card').querySelector('.task-name').textContent = newName.trim();
                                App.utils.show('ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù‡Ù…Ø©', 'success');
                            }
                        }
                    }
                }

                if (e.target.matches('.btn-delete-project') && projectId) {
                    if (App.state.projects.length === 1) return App.utils.showError(null, 'Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ø¢Ø®Ø± Ù…Ø´Ø±ÙˆØ¹.');
                    const project = App.state.projects.find(p => p.id === projectId);
                    if (confirm(`Ø­Ø°Ù Ù…Ø´Ø±ÙˆØ¹ "${project.name}" ÙˆÙƒÙ„ Ù…Ù‡Ø§Ù…Ù‡ØŸ`)) {
                        App.state.projects = App.state.projects.filter(p => p.id !== projectId);
                        App.debouncedSave();
                        e.target.closest('.project-card').remove();
                        App.utils.qs(`#taskProjectSelect option[value="${projectId}"]`).remove();
                        if (App.lastSelectedProjectId === projectId) {
                            App.lastSelectedProjectId = App.state.projects[0].id;
                            App.domCache.taskProjectSelect.value = App.lastSelectedProjectId;
                        }
                        App.utils.show('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø´Ø±ÙˆØ¹', 'success');
                    }
                }
                
                if (e.target.matches('.btn-delete-task') && projectId && taskId) {
                    if (confirm('Ø­Ø°Ù Ø§Ù„Ù…Ù‡Ù…Ø©ØŸ')) {
                        const project = App.state.projects.find(p => p.id === projectId);
                        if (project) {
                            project.tasks = project.tasks.filter(t => t.id !== taskId);
                            App.debouncedSave();
                            const taskCard = e.target.closest('.task-card');
                            taskCard.remove();
                            if (project.tasks.length === 0) {
                                App.utils.qs(`.tasks-list-for-project-${projectId}`).innerHTML = '<p class="empty-state" style="padding:10px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹.</p>';
                            }
                            App.utils.show('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù‡Ù…Ø©', 'success');
                        }
                    }
                }
                
                if (e.target.matches('.task-checkbox') && projectId && taskId) {
                    const project = App.state.projects.find(p => p.id === projectId);
                    if (project) {
                        const task = project.tasks.find(t => t.id === taskId);
                        if (task) {
                            task.completed = !task.completed;
                            App.debouncedSave();
                            const projectCard = App.utils.qs(`.project-card[data-project-id="${projectId}"]`);
                            const tasksContainer = projectCard.querySelector(`.tasks-list-for-project-${projectId}`);
                            let tasksHtml = '';
                            const sortedTasks = App.utils.sortTasks(project.tasks);
                            sortedTasks.forEach(t => {
                                tasksHtml += App.builders.taskCard(t, projectId, true);
                            });
                            tasksContainer.innerHTML = tasksHtml;
                        }
                    }
                }
            },
            
            addHabit(e) {
                const btn = e.target; btn.disabled = true;
                const name = App.domCache.habitName.value.trim();
                if (!name) return App.utils.showError(btn, 'Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ø¯Ø©');
                if (App.state.habits.find(h => h.name === name)) return App.utils.showError(btn, 'Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ø§Ø¯Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹.');
                const newHabit = {
                    id: Date.now() + '', name,
                    completedDays: [],
                    failedDays: [],
                    lastWeekStart: App.utils.getWeekStart(new Date()).getTime()
                };
                App.state.habits.push(newHabit);
                App.debouncedSave();
                if (App.state.habits.length === 1) App.domCache.habitsContainer.innerHTML = ''; 
                const habitEl = App.builders.habitCard(newHabit, true);
                App.domCache.habitsContainer.insertAdjacentHTML('beforeend', habitEl);
                App.domCache.habitName.value = '';
                App.utils.show('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ø§Ø¯Ø© âœ…', 'success');
                btn.disabled = false;
            },
            
            handleHabitClick(e) {
                const id = e.target.dataset.id;
                if (!id) return;
                const card = e.target.closest('.habit-card');
                
                if (e.target.matches('.btn-edit-habit')) {
                    const habit = App.state.habits.find(h => h.id === id);
                    if (habit) {
                        const newName = prompt('ØªØ¹Ø¯ÙŠÙ„ Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ø¯Ø©:', habit.name);
                        if (newName && newName.trim()) {
                            if (App.state.habits.find(h => h.name === newName.trim() && h.id !== id)) {
                                return App.utils.showError(null, 'Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø¹Ø§Ø¯Ø© Ø£Ø®Ø±Ù‰.');
                            }
                            habit.name = newName.trim();
                            App.debouncedSave();
                            card.querySelector('h3').textContent = newName.trim();
                            App.utils.show('ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ø§Ø¯Ø©', 'success');
                        }
                    }
                }

                if (e.target.matches('.btn-delete-habit')) {
                    if (confirm('Ø­Ø°Ù Ø§Ù„Ø¹Ø§Ø¯Ø©ØŸ')) {
                        App.state.habits = App.state.habits.filter(h => h.id !== id);
                        App.debouncedSave();
                        card.remove(); 
                        if (App.state.habits.length === 0) App.renderHabits();
                        App.utils.show('ØªÙ… Ø§Ù„Ø­Ø°Ù', 'success');
                    }
                }
                if (e.target.matches('.day-box')) {
                    const day = +e.target.dataset.day;
                    const habit = App.state.habits.find(h => h.id === id);
                    if (habit) {
                        const completedIndex = habit.completedDays.indexOf(day);
                        const failedIndex = habit.failedDays.indexOf(day);
                        let newState = 'pending';
                        let newContent = `<span class="day-name">${App.utils.getDayName(day)}</span>`;
                        let newAriaLabel = '';
                        if (completedIndex > -1) { 
                            habit.completedDays.splice(completedIndex, 1);
                            habit.failedDays.push(day);
                            newState = 'failed';
                            newContent = 'Ã—';
                            newAriaLabel = `${App.utils.getDayName(day)}: Ù„Ù… ØªÙ†Ø¬Ø²`;
                        } else if (failedIndex > -1) {
                            habit.failedDays.splice(failedIndex, 1);
                            newState = 'pending';
                            newAriaLabel = `${App.utils.getDayName(day)}: ØºÙŠØ± Ù…Ø³Ø¬Ù„`;
                        } else {
                            habit.completedDays.push(day);
                            newState = 'completed';
                            newContent = `<span class="day-name">${App.utils.getDayName(day)}</span>`;
                            newAriaLabel = `${App.utils.getDayName(day)}: Ù…ÙƒØªÙ…Ù„`;
                        }
                        App.debouncedSave();
                        e.target.className = `day-box ${newState}`;
                        e.target.innerHTML = newContent;
                        e.target.setAttribute('aria-label', newAriaLabel);
                        const count = habit.completedDays.length;
                        card.querySelector('.habit-streak').textContent = `Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²: ${count}/7`;
                        card.querySelector('.progress-bar div').style.width = `${(count / 7 * 100)}%`;
                    }
                }
            },
            
            clearUberArchive() {
                if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ø±Ø´ÙŠÙ Ø£ÙˆØ¨Ø±ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§.')) {
                    App.state.uber.archive = [];
                    App.debouncedSave();
                    App.renderUberArchive();
                    App.utils.show('ØªÙ… ØªØµÙÙŠØ± Ø§Ù„Ø£Ø±Ø´ÙŠÙ', 'success');
                }
            },
            
            showArchiveDetail(e) {
                const item = e.target.closest('.archive-item');
                if (!item) return;
                const date = item.dataset.date;
                const day = App.state.uber.archive.find(d => d.date === date);
                if (!day) return;
                let html = `<h4 style="color:var(--primary-color)">Ø§Ù„Ù…Ø´Ø§ÙˆÙŠØ±:</h4>`;
                if (day.rides.length === 0) { html += '<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§ÙˆÙŠØ± Ù…Ø³Ø¬Ù„Ø©</p>'; }
                day.rides.forEach((r, i) => { html += `<div class="list-item"><span><b>#${i+1}</b> - Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${App.utils.fmt(r.grossIncome)} | Ù…ØµØ±ÙˆÙ: ${App.utils.fmt(r.expense)} | ØµØ§ÙÙŠ: <b>${App.utils.fmt(r.net)}</b></span></div>`; });
                html += `<hr style="margin:15px 0;"><h4 style="color:var(--primary-color)">Ù…ØµØ±ÙˆÙØ§Øª Ø¹Ø§Ù…Ø©:</h4>`;
                if (day.generalExpenses.length === 0) { html += '<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ±ÙˆÙØ§Øª Ù…Ø³Ø¬Ù„Ø©</p>'; }
                day.generalExpenses.forEach(e => { html += `<div class="list-item"><span>${App.utils.escapeHTML(e.name)}: <b>-${App.utils.fmt(e.amount)}</b></span></div>`; });
                html += `<hr style="margin:15px 0;"><h3 style="text-align:left; color: #008000;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØµØ§ÙÙŠ: ${App.utils.fmt(day.netProfitToday)}</h3>`;
                App.domCache.modalTitle.textContent = `ØªÙØ§ØµÙŠÙ„ ÙŠÙˆÙ…: ${date}`;
                App.domCache.modalBody.innerHTML = html;
                App.domCache.archiveModal.style.display = 'flex';
            },

            exportData() {
                const data = { state: App.state, config: App.config };
                const a = document.createElement('a');
                a.href = URL.createObjectURL(new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' }));
                a.download = `life_dashboard_backup_v10_${new Date().toLocaleDateString('en-CA')}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                App.utils.show('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª! ğŸ“¥', 'success');
            },
            
            importData(event) {
                const file = event.target.files[0];
                if (!file || !confirm('Ø³ÙŠØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙˆØ§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡Ø§ Ø¨Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù„Ù. Ø§Ø³ØªÙ…Ø±Ø§Ø±ØŸ')) {
                    event.target.value = null; return;
                }
                const reader = new FileReader();
                reader.onload = e => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (data.state && data.config) {
                            App.state = data.state;
                            App.config = data.config;
                            localStorage.setItem(App.NEW_KEYS.state, JSON.stringify(App.state));
                            localStorage.setItem(App.NEW_KEYS.config, JSON.stringify(App.config));
                            location.reload();
                        } else {
                            throw new Error('Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­.');
                        }
                    } catch (err) {
                        App.utils.show(`Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ù„Ù: ${err.message}`, 'error');
                    }
                    event.target.value = null;
                };
                reader.readAsText(file);
            },
            
            clearAllData() {
                if (confirm('ØªØ­Ø°ÙŠØ± Ø£Ø®ÙŠØ±: Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ')) {
                    localStorage.clear();
                    location.reload();
                }
            }
        },
        
        // --- 6. HTML BUILDERS (For Selective DOM) ---
        
        builders: {
            goalCard(g, asString = false) {
                const p = g.target > 0 ? ((g.current / g.target) * 100) : 0;
                const r = g.target - g.current;
                let dueDateHtml = '';
                if (g.dueDate) {
                    const { text, isOverdue } = App.utils.getDaysRemaining(g.dueDate);
                    dueDateHtml = `<p style="color: ${isOverdue ? 'var(--danger-color)' : 'var(--text-light)'}; font-size: 0.9em;">ØªØ§Ø±ÙŠØ® Ù…Ø³ØªÙ‡Ø¯Ù: ${g.dueDate} (Ø¨Ø§Ù‚ÙŠ: ${text})</p>`;
                }
                const html = `
                <div class="card card-goal" data-id="${g.id}">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                        <h3 class="editable-name">${App.utils.escapeHTML(g.name)}</h3>
                        <button class="btn-icon btn-edit btn-edit-goal" aria-label="ØªØ¹Ø¯ÙŠÙ„ Ø§Ø³Ù… Ø§Ù„Ù‡Ø¯Ù">âœï¸</button>
                    </div>
                    ${dueDateHtml}
                    <p>Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù: <span class="value">${App.utils.fmt(g.target)}</span></p>
                    <p>Ø§Ù„Ø­Ø§Ù„ÙŠ: <span class="value current-value">${App.utils.fmt(g.current)}</span></p>
                    <p class="big-stat percent-value" style="font-size:2em; color: var(--primary-color);">${p.toFixed(1)}%</p>
                    <p style="font-weight: 600;">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: <span class="remaining-value">${App.utils.fmt(r)}</span></p>
                    <div class="progress-bar"><div style="width:${Math.min(100, p)}%"></div></div>
                    <hr style="margin:15px 0;border:none;border-top:1px solid #eee">
                    <input type="number" class="add-amount-input" placeholder="Ø¥Ø¶Ø§ÙØ© Ù…Ø¨Ù„Øº" min="1" style="padding:12px">
                    <div class="btn-group">
                        <button class="btn btn-primary btn-update-amount">Ø¥Ø¶Ø§ÙØ©</button>
                        <button class="btn btn-danger btn-delete-goal" aria-label="Ø­Ø°Ù Ø§Ù„Ù‡Ø¯Ù">Ø­Ø°Ù</button>
                    </div>
                </div>`;
                return asString ? html : App.utils.stringToEl(html);
            },
            
            incomeSourceItem(src, asString = false) {
                const html = `
                <div class="list-item" data-id="${src.id}">
                    <span>
                        <span class="list-item-name editable-name">${App.utils.escapeHTML(src.name)}</span>
                        <span class="list-item-amount">${App.utils.fmt(src.amount)}</span>
                    </span>
                    <div>
                        <button class="btn-icon btn-edit btn-edit-income" aria-label="ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ØµØ¯Ø±">âœï¸</button>
                        <button class="btn-icon btn-delete-income" aria-label="Ø­Ø°Ù Ø§Ù„Ù…ØµØ¯Ø±">âŒ</button>
                    </div>
                </div>`;
                return asString ? html : App.utils.stringToEl(html);
            },

            incomeExpectedItem(src, isExpected, asString = false) {
                const html = `
                <div class="income-list-item ${!isExpected ? 'not-expected' : ''}" data-id="${src.id}">
                    <input type="checkbox" class="income-expected-checkbox" data-id="${src.id}" ${isExpected ? 'checked' : ''} aria-label="ØªÙˆÙ‚Ø¹ Ø§Ø³ØªÙ„Ø§Ù… ${App.utils.escapeHTML(src.name)}">
                    <div class="details">
                        <span class="name">${App.utils.escapeHTML(src.name)}</span>
                    </div>
                    <span class="amount-display">${App.utils.fmt(src.amount)}</span>
                </div>`;
                return asString ? html : App.utils.stringToEl(html);
            },
            
            oneTimeIncomeItem(src, asString = false) {
                const html = `
                <div class="income-list-item" data-id="${src.id}">
                    <input type="checkbox" checked disabled>
                    <div class="details">
                        <span class="name">${App.utils.escapeHTML(src.name)} (Ø¥Ø¶Ø§ÙÙŠ)</span>
                    </div>
                    <span class="amount-display">${App.utils.fmt(src.amount)}</span>
                    <button class="btn-icon btn-delete-onetime" aria-label="Ø­Ø°Ù Ø§Ù„Ø¯Ø®Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ">âŒ</button>
                </div>`;
                return asString ? html : App.utils.stringToEl(html);
            },

            salaryTrackerCard(cat, asString = false) {
                const remaining = cat.monthlyBudget - cat.currentSpent;
                const html = `
                <div class="card salary-tracker-card" data-id="${cat.id}" style="${cat.isSinkingFund ? 'border-right-color: var(--secondary-color);' : ''}">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                        <h4 class="editable-name">${App.utils.escapeHTML(cat.name)}</h4>
                        <div>
                            ${!cat.isSinkingFund ? `<button class="btn-icon btn-edit btn-edit-category" aria-label="ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙØ¦Ø©">âœï¸</button>` : ''}
                            ${!cat.isSinkingFund ? `<button class="btn-icon btn-delete-category" aria-label="Ø­Ø°Ù Ø§Ù„ÙØ¦Ø©">âŒ</button>` : ''}
                        </div>
                    </div>
                    <label>Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ù…Ø®ØµØµØ©:</label>
                    <input type="number" class="budget-input" value="${cat.monthlyBudget}" min="0" ${cat.isSinkingFund ? 'disabled' : ''}>
                    <hr style="margin:10px 0; border:none; border-top:1px solid #f0f0f0;">
                    <p class="salary-stat"><span class="label">Ø§Ù„Ù…ØµØ±ÙˆÙ:</span> <span class="value spent">${App.utils.fmt(cat.currentSpent)}</span></p>
                    <p class="salary-stat"><span class="label">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</span> <span class="value remaining ${remaining < 0 ? 'over' : ''}">${App.utils.fmt(remaining)}</span></p>
                    <hr style="margin:10px 0; border:none; border-top:1px solid #f0f0f0;">
                    <div class="btn-group">
                        <input type="number" class="spend-input" placeholder="ØªØ³Ø¬ÙŠÙ„ Ù…ØµØ±ÙˆÙ" min="1" style="width: 60%; margin:0;">
                        <button class="btn btn-primary btn-add-expense" style="width: 40%; margin:0;">Ø³Ø¬Ù„</button>
                    </div>
                </div>`;
                return asString ? html : App.utils.stringToEl(html);
            },

            sinkingFundCard(f, asString = false) {
                const p = f.target > 0 ? ((f.current / f.target) * 100) : 0;
                const { text, isOverdue } = App.utils.getDaysRemaining(f.dueDate);
                const html = `
                <div class="card sinking-fund-card" data-id="${f.id}">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                        <h3 class="editable-name">ğŸ›¡ï¸ ${App.utils.escapeHTML(f.name)}</h3>
                        <button class="btn-icon btn-edit btn-edit-fund" aria-label="ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚">âœï¸</button>
                    </div>
                    <p style="color: ${isOverdue ? 'var(--danger-color)' : 'var(--text-light)'};">Ø§Ù„ØªØ§Ø±ÙŠØ®: ${f.dueDate} (${text})</p>
                    <p>Ø§Ù„Ù‡Ø¯Ù: <b>${App.utils.fmt(f.target)}</b></p>
                    <p>Ø§Ù„Ù…Ø­ÙÙˆØ¸: <b style="color:var(--secondary-color)">${App.utils.fmt(f.current)}</b></p>
                    <p style="font-size:0.9em;color:var(--text-light);">Ø§Ù„Ø§Ø¯Ø®Ø§Ø± Ø§Ù„Ø´Ù‡Ø±ÙŠ: <b>${App.utils.fmt(f.monthlyAmount)}</b></p>
                    <div class="progress-bar"><div style="width:${Math.min(100, p)}%"></div></div>
                    <hr style="margin:10px 0;">
                    <input type="number" class="fund-add-input" placeholder="Ø¥Ø¶Ø§ÙØ© Ù„Ù„ØµÙ†Ø¯ÙˆÙ‚" min="1">
                    <div class="btn-group">
                        <button class="btn btn-primary btn-add-to-fund">Ø¥Ø¶Ø§ÙØ©</button>
                        <button class="btn btn-danger btn-delete-fund">Ø­Ø°Ù</button>
                    </div>
                </div>`;
                return asString ? html : App.utils.stringToEl(html);
            },

            uberRideItem(r, i, asString = false) {
                const html = `<div class="list-item" data-id="${r.id}">
                    <span><b>Ù…Ø´ÙˆØ§Ø± #${i + 1}</b> (Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${App.utils.fmt(r.grossIncome)} | Ù…ØµØ±ÙˆÙ: ${App.utils.fmt(r.expense)} | ØµØ§ÙÙŠ: <b style="color:${r.net > 0 ? '#008000' : 'var(--danger-color)'}">${App.utils.fmt(r.net)}</b>)</span> 
                    <button class="btn-icon btn-delete-ride" aria-label="Ø­Ø°Ù Ø§Ù„Ù…Ø´ÙˆØ§Ø±">âŒ</button>
                </div>`;
                return asString ? html : App.utils.stringToEl(html);
            },

            uberExpenseItem(e, i, asString = false) {
                const html = `<div class="list-item" data-id="${e.id}">
                    <span><b>${App.utils.escapeHTML(e.name)}:</b> <b style="color:var(--danger-color);">- ${App.utils.fmt(e.amount)}</b></span>
                    <button class="btn-icon btn-delete-expense" aria-label="Ø­Ø°Ù Ø§Ù„Ù…ØµØ±ÙˆÙ">âŒ</button>
                </div>`;
                return asString ? html : App.utils.stringToEl(html);
            },
            
            uberArchiveItem(day, asString = false) {
                const html = `
                <div class="archive-item" data-date="${day.date}" role="button" aria-label="Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ ÙŠÙˆÙ… ${day.date}">
                    <b>ØªØ§Ø±ÙŠØ®: ${day.date}</b> | 
                    Ø§Ù„ØµØ§ÙÙŠ: <span style="font-weight:bold; color:${day.netProfitToday > 0 ? '#008000' : 'var(--danger-color)'}">${App.utils.fmt(day.netProfitToday)}</span> | 
                    (${day.rides.length} Ù…Ø´ÙˆØ§Ø±, ${day.generalExpenses.length} Ù…ØµØ±ÙˆÙ)
                    <small style="display:block; color:#555;">(Ø§Ø¶ØºØ· Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„)</small>
                </div>`;
                return asString ? html : App.utils.stringToEl(html);
            },

            projectCard(p, asString = false) {
                let tasksHtml = '';
                const sortedTasks = App.utils.sortTasks(p.tasks);
                if (sortedTasks.length === 0) {
                    tasksHtml = '<p class="empty-state" style="padding:10px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹.</p>';
                } else {
                    sortedTasks.forEach(t => {
                        tasksHtml += this.taskCard(t, p.id, true);
                    });
                }
                const html = `
                <div class="card project-card" data-project-id="${p.id}">
                    <div class="project-header">
                        <h3 class="editable-name">${App.utils.escapeHTML(p.name)}</h3>
                        <div>
                            <button class="btn-icon btn-edit btn-edit-project" data-project-id="${p.id}" aria-label="ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹">âœï¸</button>
                            <button class="btn btn-danger btn-delete-project" data-project-id="${p.id}" aria-label="Ø­Ø°Ù Ø§Ù„Ù…Ø´Ø±ÙˆØ¹" style="width: auto; padding: 10px 15px; font-size: 0.9em; margin: 0;">Ø­Ø°Ù Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</button>
                        </div>
                    </div>
                    <div class="tasks-list-for-project-${p.id}">
                        ${tasksHtml}
                    </div>
                </div>`;
                return asString ? html : App.utils.stringToEl(html);
            },

            taskCard(t, projectId, asString = false) {
                const { text, isOverdue } = App.utils.getDaysRemaining(t.dueDate);
                const tagClass = t.completed ? 'completed' : (isOverdue ? 'overdue' : '');
                const priorityMap = { high: 'Ø¹Ø§Ù„ÙŠØ© ğŸ”´', medium: 'Ù…ØªÙˆØ³Ø·Ø© ğŸŸ ', low: 'Ù…Ù†Ø®ÙØ¶Ø© ğŸ”µ' };
                const html = `
                <div class="card task-card ${t.completed ? 'completed' : ''} ${isOverdue && !t.completed ? `overdue priority-${t.priority}` : `priority-${t.priority}`}" data-project-id="${projectId}" data-task-id="${t.id}">
                    <div class="task-card-header">
                        <input type="checkbox" class="task-checkbox" data-project-id="${projectId}" data-task-id="${t.id}" ${t.completed ? 'checked' : ''} style="width:20px;height:20px;margin:0 0 0 10px;" aria-label="Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ù…Ù‡Ù…Ø©">
                        <h4 class="task-name editable-name ${t.completed ? 'completed' : ''}">${App.utils.escapeHTML(t.name)}</h4>
                        <div>
                            <button class="btn-icon btn-edit btn-edit-task" data-project-id="${projectId}" data-task-id="${t.id}" aria-label="ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù‡Ù…Ø©">âœï¸</button>
                            <button class="btn-icon btn-delete-task" data-project-id="${projectId}" data-task-id="${t.id}" aria-label="Ø­Ø°Ù Ø§Ù„Ù…Ù‡Ù…Ø©">âŒ</button>
                        </div>
                    </div>
                    <div class="task-card-footer">
                        <span class="priority-badge ${t.priority}">${priorityMap[t.priority]}</span>
                        <span class="due-date-tag ${tagClass}">ğŸ—“ï¸ ${text}</span>
                    </div>
                </div>`;
                return asString ? html : App.utils.stringToEl(html);
            },
            
            habitCard(h, asString = false) {
                const count = h.completedDays.length;
                let daysHtml = '';
                for (let i = 0; i < 7; i++) {
                    let dayState = 'pending';
                    let dayContent = `<span class="day-name">${App.utils.getDayName(i)}</span>`;
                    let ariaLabel = `${App.utils.getDayName(i)}: ØºÙŠØ± Ù…Ø³Ø¬Ù„`;
                    if (h.completedDays.includes(i)) {
                        dayState = 'completed';
                        ariaLabel = `${App.utils.getDayName(i)}: Ù…ÙƒØªÙ…Ù„`;
                    } else if (h.failedDays.includes(i)) {
                        dayState = 'failed';
                        dayContent = 'Ã—';
                        ariaLabel = `${App.utils.getDayName(i)}: Ù„Ù… ØªÙ†Ø¬Ø²`;
                    }
                    daysHtml += `<div class="day-box ${dayState}" data-id="${h.id}" data-day="${i}" role="button" aria-label="${ariaLabel}">
                                    ${dayContent}
                                 </div>`;
                }
                const html = `
                <div class="card habit-card" data-id="${h.id}">
                    <div style="position:absolute;top:10px;left:10px; display: flex; gap: 5px;">
                        <button class="btn-icon btn-edit btn-edit-habit" data-id="${h.id}" aria-label="ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ø§Ø¯Ø©">âœï¸</button>
                        <button class="btn-icon btn-delete-habit" data-id="${h.id}" aria-label="Ø­Ø°Ù Ø§Ù„Ø¹Ø§Ø¯Ø©">âŒ</button>
                    </div>
                    <h3 class="editable-name">${App.utils.escapeHTML(h.name)}</h3>
                    <div class="days-tracker">${daysHtml}</div>
                    <small class="habit-streak" style="margin-top:15px; display: block; font-size: 1em;">Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²: ${count}/7</small>
                    <div class="progress-bar"><div style="width:${(count / 7 * 100)}%"></div></div>
                </div>`;
                return asString ? html : App.utils.stringToEl(html);
            }
        },

        // --- 7. UTILITY METHODS ---
        
        utils: {
            cacheDOM() {
                App.domCache = {
                    goalsContainer: App.utils.qs('#financialGoalsContainer'),
                    budgetTrackerContainer: App.utils.qs('#budgetTrackerContainer'),
                    sinkingFundsContainer: App.utils.qs('#sinkingFundsContainer'),
                    ridesHistoryContainer: App.utils.qs('#ridesHistoryContainer'),
                    generalExpensesHistoryContainer: App.utils.qs('#generalExpensesHistoryContainer'),
                    projectsContainer: App.utils.qs('#projectsContainer'),
                    habitsContainer: App.utils.qs('#habitsContainer'),
                    uberArchiveList: App.utils.qs('#uberArchiveList'),
                    goalName: App.utils.qs('#goalName'),
                    goalAmount: App.utils.qs('#goalAmount'),
                    currentSavings: App.utils.qs('#currentSavings'),
                    goalDueDate: App.utils.qs('#goalDueDate'),
                    addGoalBtn: App.utils.qs('#addGoalBtn'),
                    totalExpectedIncomeDisplay: App.utils.qs('#totalExpectedIncomeDisplay'),
                    totalReceivedIncomeDisplay: App.utils.qs('#totalReceivedIncomeDisplay'),
                    totalAllocatedDisplay: App.utils.qs('#totalAllocatedDisplay'),
                    unallocatedAmountDisplay: App.utils.qs('#unallocatedAmountDisplay'),
                    incomeReceivedContainer: App.utils.qs('#incomeReceivedContainer'),
                    oneTimeIncomeName: App.utils.qs('#oneTimeIncomeName'),
                    oneTimeIncomeAmount: App.utils.qs('#oneTimeIncomeAmount'),
                    addOneTimeIncomeBtn: App.utils.qs('#addOneTimeIncomeBtn'),
                    newCategoryName: App.utils.qs('#newCategoryName'),
                    addCategoryBtn: App.utils.qs('#addCategoryBtn'),
                    incomeSourcesContainer: App.utils.qs('#incomeSourcesContainer'),
                    newIncomeSource: App.utils.qs('#newIncomeSource'),
                    newIncomeAmount: App.utils.qs('#newIncomeAmount'),
                    addIncomeSourceBtn: App.utils.qs('#addIncomeSourceBtn'),
                    daysUntilSalaryDisplay: App.utils.qs('#daysUntilSalaryDisplay'),
                    salaryDayLabel: App.utils.qs('#salaryDayLabel'),
                    fundName: App.utils.qs('#fundName'),
                    fundTarget: App.utils.qs('#fundTarget'),
                    fundDueDate: App.utils.qs('#fundDueDate'),
                    addFundBtn: App.utils.qs('#addFundBtn'),
                    rideIncome: App.utils.qs('#rideIncome'),
                    rideExpense: App.utils.qs('#rideExpense'),
                    addRideBtn: App.utils.qs('#addRideBtn'),
                    generalExpenseAmount: App.utils.qs('#generalExpenseAmount'),
                    generalExpenseName: App.utils.qs('#generalExpenseName'),
                    addGeneralExpenseBtn: App.utils.qs('#addGeneralExpenseBtn'),
                    endUberDayBtn: App.utils.qs('#endUberDayBtn'),
                    projectName: App.utils.qs('#projectName'),
                    addProjectBtn: App.utils.qs('#addProjectBtn'),
                    taskProjectSelect: App.utils.qs('#taskProjectSelect'),
                    taskName: App.utils.qs('#taskName'),
                    taskDueDate: App.utils.qs('#taskDueDate'),
                    taskPriority: App.utils.qs('#taskPriority'),
                    addTaskBtn: App.utils.qs('#addTaskBtn'),
                    habitName: App.utils.qs('#habitName'),
                    addHabitBtn: App.utils.qs('#addHabitBtn'),
                    configUberGoal: App.utils.qs('#configUberGoal'),
                    configUberCommission: App.utils.qs('#configUberCommission'),
                    saveUberConfigBtn: App.utils.qs('#saveUberConfigBtn'),
                    configSalaryDay: App.utils.qs('#configSalaryDay'),
                    saveSalaryConfigBtn: App.utils.qs('#saveSalaryConfigBtn'),
                    exportDataBtn: App.utils.qs('#exportDataBtn'),
                    importDataBtn: App.utils.qs('#importDataBtn'),
                    importFile: App.utils.qs('#importFile'),
                    clearAllDataBtn: App.utils.qs('#clearAllDataBtn'),
                    clearArchiveBtn: App.utils.qs('#clearArchiveBtn'),
                    uberTitle: App.utils.qs('#uberTitle'),
                    uberNetProfit: App.utils.qs('#uberNetProfit'),
                    uberRemaining: App.utils.qs('#uberRemaining'),
                    uberGrossNeeded: App.utils.qs('#uberGrossNeeded'),
                    tasksChartPercent: App.utils.qs('#tasksChartPercent'),
                    tasksChartLabel: App.utils.qs('#tasksChartLabel'),
                    habitsChartPercent: App.utils.qs('#habitsChartPercent'),
                    habitsChartLabel: App.utils.qs('#habitsChartLabel'),
                    financialChartPercent: App.utils.qs('#financialChartPercent'),
                    financialChartLabel: App.utils.qs('#financialChartLabel'),
                    archiveModal: App.utils.qs('#archiveModal'),
                    modalTitle: App.utils.qs('#modalTitle'),
                    modalBody: App.utils.qs('#modalBody'),
                    modalCloseBtn: App.utils.qs('#modalCloseBtn'),
                };
            },
            qs(selector) { return document.querySelector(selector); },
            show(msg, type = 'success') {
                const n = document.getElementById('notification');
                n.textContent = msg;
                n.className = type;
                n.style.display = 'block';
                setTimeout(() => n.style.display = 'none', 3000);
            },
            showError(btn, msg) {
                this.show(msg, 'error');
                if (btn) btn.disabled = false;
            },
            fmt(n) { return `${(n || 0).toLocaleString('ar-SA', { minimumFractionDigits: 0, maximumFractionDigits: 0 })} Ø±ÙŠØ§Ù„`; },
            getToday() { 
                const d = new Date(); 
                return d.getFullYear() + '-' + (d.getMonth() + 1).toString().padStart(2, '0') + '-' + d.getDate().toString().padStart(2, '0');
            },
            getDayName(i) { 
                const names = ['Ø­', 'Ù†', 'Ø«', 'Ø±', 'Ø®', 'Ø¬', 'Ø³'];
                return names[i]; 
            },
            getDaysRemaining(dueDateStr) {
                if (!dueDateStr) return { text: '', isOverdue: false };
                const today = new Date();
                today.setHours(0, 0, 0, 0); 
                const parts = dueDateStr.split('-');
                const due = new Date(parts[0], parts[1] - 1, parts[2]);
                due.setHours(0, 0, 0, 0);
                const diff = Math.ceil((due.getTime() - today.getTime()) / (1000 * 60 * 60 * 24));
                if (diff === 0) return { text: 'Ø§Ù„ÙŠÙˆÙ…', isOverdue: false };
                if (diff < 0) return { text: `Ù…ØªØ£Ø®Ø± ${Math.abs(diff)} ÙŠÙˆÙ…`, isOverdue: true };
                return { text: `${diff} ÙŠÙˆÙ…`, isOverdue: false };
            },
            getWeekStart(d) {
                const date = new Date(d);
                const day = date.getDay();
                const diff = date.getDate() - day;
                return new Date(date.setDate(diff));
            },
            escapeHTML(str) {
                if (typeof str !== 'string') return '';
                const p = document.createElement('p');
                p.textContent = str;
                return p.innerHTML;
            },
            safeParse(jsonString) {
                try {
                    return JSON.parse(jsonString);
                } catch (e) {
                    return null;
                }
            },
            stringToEl(htmlString) {
                const div = document.createElement('div');
                div.innerHTML = htmlString.trim();
                return div.firstChild;
            },
            sortTasks(tasks) {
                const priorityOrder = { high: 1, medium: 2, low: 3 };
                return tasks.sort((a, b) => {
                    if (a.completed !== b.completed) {
                        return a.completed ? 1 : -1;
                    }
                    if (priorityOrder[a.priority] !== priorityOrder[b.priority]) {
                        return priorityOrder[a.priority] - priorityOrder[b.priority];
                    }
                    return new Date(a.dueDate) - new Date(b.dueDate);
                });
            },
            createDonutChart(canvasId, percent, color) {
                const ctxEl = document.getElementById(canvasId);
                if (!ctxEl) return;
                const ctx = ctxEl.getContext('2d');
                const remaining = 100 - percent;
                if (App.charts[canvasId]) {
                    App.charts[canvasId].destroy();
                }
                App.charts[canvasId] = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        datasets: [{
                            data: [percent, remaining > 0 ? remaining : 0.001],
                            backgroundColor: [color, '#e9ecef'],
                            borderWidth: 0,
                            borderRadius: 5,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '75%',
                        plugins: {
                            legend: { display: false },
                            tooltip: { enabled: false }
                        },
                        animation: {
                            duration: 1000
                        }
                    }
                });
            },
            createPieChart(canvasId, labels, data, colors) {
                const ctxEl = document.getElementById(canvasId);
                if (!ctxEl) return;
                const ctx = ctxEl.getContext('2d');
                if (App.charts[canvasId]) {
                    App.charts[canvasId].destroy();
                }
                App.charts[canvasId] = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: colors,
                            borderWidth: 0,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.label || '';
                                        let value = context.raw || 0;
                                        return `${label}: ${App.utils.fmt(value)}`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }
    };
    
    // Run the app
    App.init();

});
</script>
</body>
</html>
